{
  "version": "v1",
  "artifact": "kubeopencode-sdp-adapter-contract",
  "issue_id": "sdp_dev-2aq.7.1",
  "references": {
    "design_doc": "docs/KUBEOPENCODE_SDP_ADAPTER_ARCHITECTURE.md",
    "fit_gap": "specs/runtime/kubeopencode-sdp-fit-gap.json"
  },
  "crd_mapping": {
    "task": [
      {
        "source": "metadata.name",
        "target": "run_context.run_id",
        "rule": "stable issue-attempt mapping",
        "deterministic": true
      },
      {
        "source": "metadata.labels[beads.issue]",
        "target": "trace.issue_id",
        "rule": "required issue correlation label",
        "deterministic": true
      },
      {
        "source": "spec.prompt",
        "target": "evidence.intent",
        "rule": "normalized prompt hash",
        "deterministic": true
      },
      {
        "source": "spec.agentRef",
        "target": "plan.role_binding",
        "rule": "table-driven role mapping",
        "deterministic": true
      },
      {
        "source": "status.phase=Succeeded",
        "target": "fsm.review_to_verified_candidate",
        "rule": "requires verification and policy pass",
        "deterministic": true
      },
      {
        "source": "status.phase=Failed",
        "target": "fsm.blocked_or_escalated",
        "rule": "retry budget with terminal reason taxonomy",
        "deterministic": true
      }
    ],
    "agent": [
      {
        "source": "metadata.name",
        "target": "execution.actor",
        "rule": "provenance actor binding",
        "deterministic": true
      },
      {
        "source": "spec.model",
        "target": "policy.model_allowlist_gate",
        "rule": "deny on non-allowlisted model",
        "deterministic": true
      },
      {
        "source": "spec.tools",
        "target": "plan.declared_tools",
        "rule": "persist declared execution capabilities",
        "deterministic": true
      }
    ]
  },
  "boundary_contracts": {
    "beads": {
      "source_of_truth": "beads",
      "required_outputs": [
        "state_update",
        "terminal_reason",
        "trace.run_context_link",
        "trace.evidence_context_link"
      ]
    },
    "fsm": {
      "canonical_path": [
        "open",
        "in_progress",
        "review",
        "verified",
        "done"
      ],
      "side_states": [
        "blocked",
        "escalated",
        "cancelled"
      ],
      "denial_reasons": [
        "policy_denied",
        "verification_failed",
        "dependency_blocked",
        "runtime_failed"
      ]
    },
    "evidence": {
      "required_sections": [
        "intent",
        "plan",
        "execution",
        "verification",
        "review",
        "risk_notes",
        "boundary",
        "provenance",
        "trace"
      ],
      "provenance_requirements": [
        "task_uid",
        "task_resource_version",
        "agent_uid",
        "controller_build_fingerprint"
      ]
    },
    "policy": {
      "gate_points": [
        "pre_dispatch_model_allowlist",
        "pre_close_risk_threshold",
        "pre_publish_go_no_go"
      ],
      "visibility": "internal_only"
    }
  },
  "integration_scenarios": [
    {
      "id": "SCN-001",
      "name": "happy_path",
      "expected_terminal_state": "done"
    },
    {
      "id": "SCN-002",
      "name": "retry_then_escalate",
      "expected_terminal_state": "escalated"
    },
    {
      "id": "SCN-003",
      "name": "policy_denial_after_success",
      "expected_terminal_state": "blocked"
    },
    {
      "id": "SCN-004",
      "name": "duplicate_dispatch_rejected",
      "expected_terminal_state": "in_progress"
    }
  ],
  "migration": {
    "phases": [
      "shadow_mode",
      "canary_write",
      "full_activation"
    ],
    "rollback_steps": [
      "disable_adapter_write_flag",
      "route_to_baseline_probe_workflow",
      "preserve_evidence_and_mark_blocked",
      "annotate_inflight_tasks_with_rollback_guard"
    ]
  }
}
