---
ws_id: "00-063-02"
feature_id: "F063"
title: "Staged Guard Checks and CI Diff Range"
status: "complete"
priority: "P0"
depends_on: ["00-063-01"]
blocks: ["00-063-04"]
project_id: "00"
---

# 00-063-02: Staged Guard Checks and CI Diff Range

## Goal

Add Guardian-style staged diff checks to SDP with hybrid blocking behavior and predictable local/CI outputs.

## Context

`sdp guard` currently focuses on scope control. This workstream adds staged policy checks for changed lines and standardizes result contracts for local hooks and CI.

## Source of inspiration

- [guardian-cli check command flow](https://github.com/AlexGladkov/guardian-cli/blob/main/internal/cli/check.go)
- [guardian-cli CI diff-range detection](https://github.com/AlexGladkov/guardian-cli/blob/main/internal/git/ci.go)
- [guardian-cli diff parser](https://github.com/AlexGladkov/guardian-cli/blob/main/internal/engine/diff_parser.go)

## Acceptance Criteria

- [x] AC1: New command supports staged checks (e.g., `sdp guard check --staged`)
- [x] AC2: Rule evaluation classifies findings into `ERROR` and `WARNING`
- [x] AC3: Exit codes are stable: `0` pass, `1` policy violation, `2` runtime/config error
- [x] AC4: Human-readable output for local usage
- [x] AC5: JSON output mode for CI (`--json`)
- [x] AC6: CI diff-range auto-detection uses base/head envs with safe fallback
- [x] AC7: `pre-commit` and `pre-push` call staged guard checks
- [x] AC8: Hybrid mode enforced: block on `ERROR`, warn on `WARNING`

## Scope Files

**Implementation:**
- sdp-plugin/cmd/sdp/guard.go (update)
- sdp-plugin/internal/guard/skill.go (update)
- sdp-plugin/internal/guard/models.go (update)
- hooks/pre-commit.sh (update)
- hooks/pre-push.sh (update)

**Tests:**
- sdp-plugin/internal/guard/skill_test.go (update)
- sdp-plugin/cmd/sdp/guard_test.go (update)

## Notes

- ~2.5h work
- Keep existing scope check behavior intact (do not regress `activate/check/status/deactivate`)
- Ensure path normalization is deterministic for staged files
