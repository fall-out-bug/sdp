---
ws_id: "00-075-04"
feature_id: "F075"
title: "WS: Safe Config Migrations"
status: completed
priority: 2
size: MEDIUM
depends_on: []
blocks: []
---

# WS: Safe Config Migrations

**Feature**: F075 - Self-Healing Doctor
**ID**: 00-075-04
**Priority**: P0
**Depends on**: 00-075-01

## Goal
Add automatic config migration with backup/rollback support for version upgrades.

## Scope Files
- `sdp-plugin/cmd/sdp/doctor.go`
- `sdp-plugin/internal/doctor/doctor_migrate.go`
- `sdp-plugin/internal/doctor/doctor_migrate_ops.go`

## Acceptance Criteria
- [x] AC1: Detects outdated `.sdp/config.yml` version
- [x] AC2: Creates timestamped backup before migration
- [x] AC3: Migrates config to latest version preserving all settings
- [x] AC4: Validates migrated config
- [x] AC5: Supports `--rollback` to restore from backup
- [x] AC6: Logs migration history to `.sdp/migrations.log`
- [x] AC7: Tests for migrations (>= 80% coverage)

## Implementation Summary

Implemented:
- `MigrateConfig(dryRun bool)`: Migrates config with backup
- `RollbackMigration(backupPath string)`: Restores from backup
- `MigrationRegistry`: Map of version to migration functions
- `createConfigBackup()`: Creates timestamped backup in `.sdp/backups/`
- `logMigration()`: Records to `.sdp/migrations.log`
- `detectConfigVersion()`: Parses version from config content
- `ListBackups()`: Lists available backup files

## Test Coverage
- Unit tests in `doctor_migrate_test.go`
- Coverage: 85.1% (exceeds 80% requirement)
