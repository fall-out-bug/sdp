---
ws_id: "00-054-05"
feature_id: "F054"
title: "@build Evidence Instrumentation"
status: "completed"
priority: "P0"
depends_on: ["00-054-04"]
blocks: ["00-054-09"]
project_id: "00"
---

# 00-054-05: @build Evidence Instrumentation

## Goal

Instrument existing CLI commands to emit evidence events. Start with `@build` flow only: guard → tdd → verify.

## Context

From VISION.md: "Instrument @build first, not all 19 skills." The `@build` skill calls these CLI commands:
- `sdp guard activate` — start of workstream
- `sdp tdd red/green/refactor` — TDD phases  
- `sdp verify` — workstream completion
- `sdp quality` — quality gate checks

Each should emit evidence events.

## Acceptance Criteria

- [ ] AC1: `sdp guard activate` emits `plan` event (ws_id, scope_files, timestamp)
- [ ] AC2: `sdp tdd green` emits `generation` event (model_id from env, files changed)
- [ ] AC3: `sdp verify` emits `verification` event (pass/fail, coverage)
- [ ] AC4: `sdp quality` emits `verification` event (gate results)
- [ ] AC5: Model ID read from `SDP_MODEL_ID` env var (or "unknown")
- [ ] AC6: Events written via evidence.Writer (not telemetry)
- [ ] AC7: Evidence emission is non-blocking — failure to write evidence doesn't break the build
- [ ] AC8: Feature flag: `evidence.enabled` in `.sdp/config.yml` (default: true)

## Scope Files

**Implementation:**
- sdp-plugin/cmd/sdp/guard.go (update — add evidence emit)
- sdp-plugin/cmd/sdp/tdd.go (update — add evidence emit)
- sdp-plugin/cmd/sdp/verify.go (update — add evidence emit)
- sdp-plugin/cmd/sdp/quality.go (update — add evidence emit)
- sdp-plugin/internal/evidence/emitter.go (new — helper to create events)
- sdp-plugin/internal/evidence/emitter_test.go (new)

**Tests:**
- sdp-plugin/internal/evidence/emitter_test.go
- sdp-plugin/cmd/sdp/guard_test.go (update)

## Integration Pattern

```go
// In guard.go, after activation:
if evidenceEnabled() {
    evidence.Emit(evidence.Event{
        Type: evidence.Plan,
        WSID: wsID,
        Data: map[string]interface{}{
            "scope_files": scopeFiles,
            "action":      "activate",
        },
    })
}
```

## Verification

```bash
cd sdp-plugin && go test ./internal/evidence/... ./cmd/sdp/... -v -cover
# After running @build on test project, verify events.jsonl has entries
```

## Notes

- ~2h work
- Non-blocking: wrap in goroutine or ignore error
- Model ID: Claude Code sets `ANTHROPIC_MODEL` or similar — detect from env
- This is the "thin evidence" — model_id + pass/fail + timestamp. Full verification output comes later.
