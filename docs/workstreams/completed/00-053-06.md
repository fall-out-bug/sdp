---
ws_id: "00-053-06"
feature_id: "F053"
title: "Workstream 00-053-06: Implement `sdp contract lock` CLI"
status: complete
priority: 2
size: MEDIUM
depends_on: []
blocks: []
---

# Workstream 00-053-06: Implement `sdp contract lock` CLI

**Feature:** F053 - Component Contract Validation
**Issue:** sdp-ie25.7
**Project ID:** 00
**Status:** Pending
**Priority:** P1

## Overview

Implement the `sdp contract lock` CLI command that freezes agreed contracts and creates a verification checkpoint. This prevents contract drift during implementation.

## Problem Statement

After contract synthesis (WS 00-053-00) completes:
- Contract exists but not locked
- Agents can modify contract during implementation
- No way to verify implementation matches agreed contract
- No checkpoint for @review validation

## Solution

Add `contract lock` subcommand to SDP CLI:
```bash
sdp contract lock --feature=telemetry --sha=abc123
```

Locking creates:
1. Immutable contract hash
2. Git commit SHA reference
3. Locked timestamp
4. Verification checksum

## Acceptance Criteria

1. **CLI command** implemented in `src/sdp/cli/contract_commands.go`
2. Subcommand: `sdp contract lock`
3. Required flags:
   - `--feature` (feature name)
   - `--sha` (git commit SHA of contract)
4. Optional flags:
   - `--contract` (path to contract file, default: `.contracts/{feature}.yaml`)
5. Locking process:
   - Reads contract file
   - Calculates SHA256 hash
   - Creates lock file at `.contracts/{feature}.lock`
   - Stores: contract_hash, git_sha, timestamp, checksum
6. Verification:
   - Subcommand: `sdp contract verify --feature=telemetry`
   - Checks if contract matches lock
   - Returns exit code 1 if mismatch
7. Error handling:
   - Contract file not found
   - Lock file already exists
   - Invalid git SHA

## Scope

### In Scope
- CLI command implementation
- Lock file creation
- Contract verification
- Error handling
- Lock file format specification

### Out of Scope
- Contract synthesis (WS 00-053-00)
- @review integration (WS 00-053-07)

## Implementation Approach

### Phase 1: Lock Command
1. Add `LockCmd` to `contract_commands.go`
2. Parse flags: `--feature`, `--sha`, `--contract`
3. Read contract file
4. Calculate SHA256 hash
5. Create lock file

### Phase 2: Lock File Format
1. Define YAML structure:
   ```yaml
   contract_file: .contracts/telemetry.yaml
   contract_hash: abc123...
   git_sha: def456...
   locked_at: 2026-02-07T00:00:00Z
   checksum: sha256:...
   ```
2. Write to `.contracts/{feature}.lock`

### Phase 3: Verify Command
1. Add `VerifyCmd` to `contract_commands.go`
2. Parse `--feature` flag
3. Read contract and lock files
4. Compare hashes
5. Return exit code 0 (match) or 1 (mismatch)

### Phase 4: Error Handling
1. Check contract exists
2. Check lock doesn't exist (idempotent: allow re-lock with --force)
3. Validate git SHA format
4. Print clear error messages

## Dependencies

**UPSTREAM:**
- WS 00-053-00 (Contract synthesis provides contract)
- WS 00-053-05 (Synthesize command creates contract)

**DOWNSTREAM:**
- WS 00-053-07 (@review uses verify command)

## Testing

### Unit Tests
- `TestLockCmd_CreateLock`
- `TestLockCmd_ContractNotFound`
- `TestLockCmd_LockAlreadyExists`
- `TestVerifyCmd_Match`
- `TestVerifyCmd_Mismatch`

### Integration Tests
- `TestEndToEnd_LockAndVerify`
- Create sample contract
- Lock it
- Verify it
- Tamper with contract
- Verify fails

## Quality Gates

- Files < 200 LOC
- Cyclomatic complexity < 10
- Test coverage ≥ 80%
- No bare exceptions
- Full type hints

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tests passing
- [ ] Coverage ≥ 80%
- [ ] Integration test passes
- [ ] Lock file format documented
- [ ] Verification works correctly

## Notes

**CLI Usage:**
```bash
# Lock contract
sdp contract lock --feature=telemetry --sha=abc123def456

# Verify contract (before @review)
sdp contract verify --feature=telemetry

# Force re-lock (if contract updated)
sdp contract lock --feature=telemetry --sha=newsha --force
```

**Lock Output:**
```
$ sdp contract lock --feature=telemetry --sha=abc123
✓ Contract read: .contracts/telemetry.yaml
✓ Contract hash: a1b2c3d4...
✓ Lock file created: .contracts/telemetry.lock
✓ Locked at: 2026-02-07T12:34:56Z

Contract is now immutable. Any changes will require re-lock.
```

**Verify Output:**
```
$ sdp contract verify --feature=telemetry
✓ Contract matches lock
✓ Locked SHA: abc123def456
✓ Locked at: 2026-02-07T12:34:56Z

$ sdp contract verify --feature=telemetry
✗ Contract mismatch detected!
  Expected hash: a1b2c3d4...
  Actual hash: e5f6g7h8...
  Contract has been modified since lock.
  Please re-lock or restore original contract.
```

**Lock File Format:**
```yaml
contract_file: .contracts/telemetry.yaml
contract_hash: a1b2c3d4e5f6...
git_sha: abc123def456...
locked_at: "2026-02-07T12:34:56Z"
checksum: "sha256:x1y2z3..."
metadata:
  feature: telemetry
  version: "1.0.0"
  endpoints: 5
  schemas: 8
```

## Execution Report Template

```
**Started:** [Timestamp]
**Completed:** [Timestamp]
**Duration:** Xm

**Files Modified:**
- src/sdp/cli/contract_commands.go (MODIFIED, added lock/verify)
- src/sdp/cli/contract_commands_test.go (MODIFIED, added tests)
  - X lines added

**Test Results:**
- Unit tests: X/Y passing
- Integration tests: A/B passing
- Coverage: Z%

**CLI Commands:**
- sdp contract lock: IMPLEMENTED
- sdp contract verify: IMPLEMENTED
- Lock file format: DEFINED

**Challenges:**
- [Any issues encountered]
```
