---
ws_id: 00-051-04
feature_id: F051
title: "Agent Coordination: Event Sourcing"
status: completed
priority: 0
depends_on: []
blocks: [00-051-05, 00-051-06]
project_id: sdp
beads_id: sdp-6fx.5
---

## Goal

Implement event-sourced agent coordination via evidence.jsonl. All agent actions emit events that can be replayed.

## Context

Part of F051 Long-term Memory System. Provides single source of truth for agent coordination using existing evidence.jsonl infrastructure.

**Related Beads:** sdp-6fx.5 (Event-sourced agent coordination)

**Existing Code:** internal/executor/evidence.go already generates events.

## Acceptance Criteria

- [ ] AC1: Define agent event types (agent_start, agent_action, agent_complete, agent_error)
- [ ] AC2: Event schema with agent_id, role, task_id, timestamp, payload
- [ ] AC3: Event store reader for replaying agent history
- [ ] AC4: Event aggregation for status summaries
- [ ] AC5: Hash chain verification for event integrity

## Scope Files

```yaml
scope_files:
  - sdp-plugin/internal/coordination/events.go        # NEW
  - sdp-plugin/internal/coordination/events_test.go   # NEW
  - sdp-plugin/internal/coordination/store.go         # NEW
  - sdp-plugin/internal/coordination/store_test.go    # NEW
  - sdp-plugin/internal/executor/evidence.go          # MODIFY
```

## Implementation Notes

### Event Schema

```go
type AgentEvent struct {
    ID        string                 `json:"id"`
    Type      string                 `json:"type"` // agent_start, agent_action, etc.
    AgentID   string                 `json:"agent_id"`
    Role      string                 `json:"role"` // implementer, reviewer, etc.
    TaskID    string                 `json:"task_id"`
    Timestamp time.Time              `json:"timestamp"`
    Payload   map[string]interface{} `json:"payload"`
    PrevHash  string                 `json:"prev_hash"`
    Hash      string                 `json:"hash"`
}
```

### Event Types

| Type | Description | Payload |
|------|-------------|---------|
| agent_start | Agent begins work | role, task_id, ws_id |
| agent_action | Agent performs action | action, details |
| agent_complete | Agent finishes | result, metrics |
| agent_error | Agent encounters error | error, recoverable |
| agent_handoff | Agent passes to another | to_agent_id |

### Integration with evidence.jsonl

Extend existing EvidenceEvent to include agent events. Use same hash chain mechanism.

## Definition of Done

- [ ] All AC met
- [ ] Tests pass with â‰¥80% coverage
- [ ] CLI command: `sdp coordination events --agent=<id>`
- [ ] Event replay works correctly
