---
ws_id: 00-050-09
parent: sdp-79u
feature: F050
status: backlog
size: MEDIUM
project_id: 00
---

## WS-00-050-09: Drift Detector (Documentation-Code Sync)

### üéØ Goal

Detect mismatches between Contract section and implementation. Enable drift detection BEFORE implementation, not after. Block commit if drift exceeds threshold without deviation declaration.

**What must WORK after completing this WS:**
- Extract fingerprint from Contract section (pre-build)
- Parse implementation code to extract actual functions/classes
- Calculate drift score (Jaccard similarity)
- Block commit if drift > threshold (0.5) without deviation declaration
- `sdp drift check <ws-id>` displays drift analysis

**Acceptance Criteria:**
- [ ] AC1: Fingerprint extracted from Contract section
- [ ] AC2: Implementation code parsed for actual functions/classes
- [ ] AC3: Drift score calculated (1.0 - Jaccard similarity)
- [ ] AC4: Commit blocked if drift >0.5 without deviation
- [ ] AC5: `sdp drift check <ws-id>` displays analysis
- [ ] Coverage ‚â• 80%

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### üìã Contracts

**Technical Constraints:**
- Must parse Contract section from workstream frontmatter
- Must extract function/class signatures from Python code
- Must use Jaccard similarity for drift calculation
- Must support deviation declaration in frontmatter

---

### üîå Interfaces

```go
package drift

type Fingerprint struct {
    ContractSHA256  string
    ExpectedLogic   string // "generic" or "business"
    ExpectedFuncs   []string
    ExpectedClasses []string
}

type ActualFingerprint struct {
    ActualFuncs   []string
    ActualClasses []string
}

type DriftResult struct {
    Score         float64
    Expected      Fingerprint
    Actual        ActualFingerprint
    MissingFuncs  []string
    ExtraFuncs    []string
    HasDeviation  bool
    DeviationReason string
}

type Detector struct {
    workstreamPath string
    threshold      float64
}

func NewDetector(wsPath string) (*Detector, error)
func (d *Detector) ExtractFingerprint() (*Fingerprint, error)
func (d *Detector) ExtractActual() (*ActualFingerprint, error)
func (d *Detector) CalculateDrift(expected *Fingerprint, actual *ActualFingerprint) (*DriftResult, error)
func (d *Detector) CheckDrift() (*DriftResult, error)
func (d *Detector) HasDeviationDeclaration() bool
```

---

### üìÅ Scope Files

**Implementation:**
- `internal/validators/drift/fingerprint.go`
- `internal/validators/drift/parser.go`
- `internal/validators/drift/detector.go`
- `cmd/sdp/commands/drift.go`

**Tests:**
- `internal/validators/drift/detector_test.go`

---

### ‚úÖ Testing

**Unit Tests:**
```bash
# Fingerprint extraction
TestExtractFingerprint()
TestExtractFingerprintNoContract()

# Code parsing
TestParsePythonCode()
TestParseFunctions()
TestParseClasses()

# Drift calculation
TestCalculateDriftNoDrift()
TestCalculateDriftWithDrift()
TestCalculateDriftJaccardSimilarity()

# Deviation handling
TestHasDeviationDeclaration()
TestDeviationBlocksCommit()
```

**Integration Tests:**
```bash
# Pre-build: extract fingerprint
sdp build 00-040-04 --fingerprint-only
‚úÖ Fingerprint stored: contract_sha256=abc123...
  Expected logic: generic validator
  Expected functions: [validate(), apply_rules()]

# Post-build: detect drift
sdp build 00-040-04
‚ö†Ô∏è Drift detected: score 0.75 > threshold 0.5
   Expected: generic validator
   Actual: business logic in quality/models.py
   Declare deviation? [y/N]: y
   Deviation reason: Required for edge case handling in payment flow
   ‚úÖ Workstream 00-040-04 completed with deviation
```

---

### üîç Verification

**Pre-build:**
- [ ] Review Contract section parsing
- [ ] Verify Python code parser
- [ ] Check Jaccard similarity calculation
- [ ] Test deviation declaration logic

**Post-build:**
```bash
# Run tests
go test ./internal/validators/drift/... -v -cover

# Manual integration test
sdp drift check 00-050-09

# Expected output:
‚úÖ No drift detected (score: 0.0)
# OR
‚ö†Ô∏è Drift detected (score: 0.65)
   Missing functions: [validate()]
   Extra functions: [process_payment()]
```

---

### üìù Notes

**Dependencies:** 00-050-04, 00-050-07

**Context:**
Drift detector (800 LOC). Recommendation from deep-thinking: "Documentation-code mismatch is core pain point. Drift detection catches it BEFORE implementation, not after."

**Key Decisions:**
- Contract fingerprint: SHA256 + expected logic type
- Jaccard similarity: |A ‚à© B| / |A ‚à™ B|
- Drift threshold: 0.5 (tunable)
- Deviation declaration: YAML in frontmatter

**Risks:**
- Contract section missing or malformed
- Python parser fails on complex code
- False positives (legitimate deviations)
- Commit blocking too aggressive

**Mitigations:**
- Validate Contract section format
- Use robust Python parser (ast module)
- Deviation declaration for intentional drift
- Configurable threshold

**Jaccard Similarity Formula:**
```
similarity = |A ‚à© B| / |A ‚à™ B|
drift = 1.0 - similarity

Where:
A = expected functions/classes
B = actual functions/classes
```

**Deviation Declaration Format:**
```yaml
---
drift_deviation:
  declared: true
  reason: "Required for edge case handling in payment flow"
  score: 0.75
---
```

**Drift Score Interpretation:**
- 0.0 - 0.2: Minimal drift (acceptable)
- 0.2 - 0.5: Moderate drift (warning)
- >0.5: Significant drift (block or require deviation)

**Integration with Git Hooks:**
```bash
# Pre-commit hook
sdp drift check $WS_ID
if [ $? -ne 0 ]; then
    echo "‚ùå Drift detected without deviation declaration"
    echo "Either fix the drift or declare a deviation in the workstream"
    exit 1
fi
```
