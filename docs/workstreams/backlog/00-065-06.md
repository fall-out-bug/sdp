---
ws_id: 00-065-06
feature_id: F065
title: "Feature Branch Enforcement"
status: backlog
priority: 0
depends_on: [00-065-01]
blocks: []
project_id: sdp
beads_id: sdp-7nzs
---

## Goal

Enforce that features are ONLY implemented in feature branches, never in dev or main.

## Context

Agents sometimes commit to dev directly instead of using feature branches. This violates SDP workflow and bypasses PR review.

**Design Reference:** docs/plans/2026-02-12-agent-git-safety-protocol.md (Section 2, 5)

## Acceptance Criteria

- [ ] AC1: Protocol update in PROTOCOL.md documenting feature branch requirement
- [ ] AC2: Guard rejects commits to dev/main when feature_id is set
- [ ] AC3: `sdp guard branch check` command to validate branch for feature
- [ ] AC4: Pre-commit hook blocks commits to protected branches for feature work
- [ ] AC5: @build skill verifies feature branch before starting
- [ ] AC6: Clear error when trying to build feature on wrong branch
- [ ] AC7: Unit tests with â‰¥80% coverage

## Scope Files

```yaml
scope_files:
  - docs/PROTOCOL.md                        # UPDATE: feature branch rule
  - sdp-plugin/cmd/sdp/guard_branch.go      # NEW: branch validation CLI
  - sdp-plugin/internal/guard/
    - branch.go                             # NEW: branch enforcement logic
  - hooks/pre-commit                        # UPDATE: protected branch check
  - .claude/skills/build/SKILL.md           # UPDATE: branch verification
```

## Protocol Update

Add to PROTOCOL.md:

```markdown
## Feature Branch Rule

**CRITICAL:** Features MUST be implemented in feature branches.

### Allowed Branches

| Branch Type | Purpose | Example |
|-------------|---------|---------|
| `feature/F###` | Feature implementation | `feature/F065` |
| `bugfix/issue-id` | Bug fixes | `bugfix/sdp-1234` |
| `hotfix/issue-id` | Emergency fixes | `hotfix/sdp-1234` |

### Protected Branches

| Branch | Allowed Operations |
|--------|-------------------|
| `main` | Merge only (via PR) |
| `dev` | Merge only (via PR) |

### Enforcement

- Guard rejects commits to protected branches when feature_id is active
- `@build` verifies feature branch before starting work
- Hooks block direct commits to dev/main
```

## Guard Commands

```bash
# Check if current branch is valid for feature
sdp guard branch check --feature=F065
# Exit 0: on feature/F065
# Exit 1: on dev/main (with error message)

# Validate branch naming
sdp guard branch validate feature/F065
# Checks: prefix, feature ID format
```

## Pre-Commit Hook Update

```bash
# Add to pre-commit hook
if [ -f ".sdp/session.json" ]; then
    FEATURE_ID=$(jq -r '.feature_id' .sdp/session.json)
    CURRENT_BRANCH=$(git branch --show-current)

    # Block commits to protected branches for feature work
    if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "dev" ]]; then
        echo "ERROR: Cannot commit to $CURRENT_BRANCH for feature $FEATURE_ID"
        echo ""
        echo "Create a feature branch:"
        echo "  git checkout -b feature/$FEATURE_ID"
        exit 1
    fi

    # Verify branch matches feature
    EXPECTED_BRANCH="feature/$FEATURE_ID"
    if [[ "$CURRENT_BRANCH" != feature/* ]]; then
        echo "WARNING: Not on a feature branch"
        echo "  Current: $CURRENT_BRANCH"
        echo "  Expected: $EXPECTED_BRANCH"
    fi
fi
```

## @build Integration

```markdown
## Pre-Build Verification

Before starting work on any workstream:

```bash
# Verify feature branch
sdp guard branch check --feature=$FEATURE_ID

# If fails:
# ERROR: Must be on feature branch for F065
# Current: dev
# Run: git checkout -b feature/F065
```

If not on feature branch, @build will:
1. Display error with clear instructions
2. NOT proceed with implementation
3. Suggest creating correct branch
```

## Error Messages

```
ERROR: Feature F065 requires feature branch
  Current branch: dev
  Required branch: feature/F065

Create the branch:
  git checkout -b feature/F065

Or if branch exists:
  git checkout feature/F065
```
