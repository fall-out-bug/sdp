---
ws_id: 00-065-04
feature_id: F065
title: "Git Hooks Protection"
status: backlog
priority: 1
depends_on: [00-065-01]
blocks: []
project_id: sdp
beads_id: sdp-dszp
---

## Goal

Implement git hooks that validate session before commits and pushes.

## Context

Hooks provide defense-in-depth protection even if agents bypass the wrapper.

**Design Reference:** docs/plans/2026-02-12-agent-git-safety-protocol.md (Section 5)

## Acceptance Criteria

- [ ] AC1: Create pre-commit hook that validates session
- [ ] AC2: Create pre-push hook that validates branch tracking
- [ ] AC3: Create post-checkout hook that updates session
- [ ] AC4: Implement `sdp hooks install` command
- [ ] AC5: Hooks work in both main repo and worktrees
- [ ] AC6: Clear error messages with remediation guidance
- [ ] AC7: Unit tests with â‰¥80% coverage

## Scope Files

```yaml
scope_files:
  - hooks/pre-commit                        # NEW: commit validation
  - hooks/pre-push                          # NEW: push validation
  - hooks/post-checkout                     # NEW: session update
  - sdp-plugin/cmd/sdp/hooks.go            # NEW: hooks install CLI
```

## pre-commit Hook

```bash
#!/bin/bash
set -e

# Get current context
CURRENT_BRANCH=$(git branch --show-current)
CURRENT_DIR=$(pwd)

# Check for session file
if [ -f ".sdp/session.json" ]; then
    EXPECTED_BRANCH=$(jq -r '.expected_branch' .sdp/session.json)
    EXPECTED_DIR=$(jq -r '.worktree_path' .sdp/session.json)

    # Validate branch
    if [ "$CURRENT_BRANCH" != "$EXPECTED_BRANCH" ]; then
        echo "ERROR: Branch mismatch!"
        echo "  Expected: $EXPECTED_BRANCH"
        echo "  Current:  $CURRENT_BRANCH"
        echo ""
        echo "Run: sdp session sync"
        exit 1
    fi

    # Validate directory
    if [ "$CURRENT_DIR" != "$EXPECTED_DIR" ]; then
        echo "ERROR: Directory mismatch!"
        echo "  Expected: $EXPECTED_DIR"
        echo "  Current:  $CURRENT_DIR"
        exit 1
    fi
fi

exit 0
```

## pre-push Hook

```bash
#!/bin/bash
set -e

REMOTE="$1"
URL="$2"
CURRENT_BRANCH=$(git branch --show-current)

# Check session
if [ -f ".sdp/session.json" ]; then
    EXPECTED_REMOTE=$(jq -r '.expected_remote' .sdp/session.json)
    EXPECTED_PUSH_TARGET="origin/$CURRENT_BRANCH"

    if [ "$EXPECTED_REMOTE" != "$EXPECTED_PUSH_TARGET" ]; then
        echo "ERROR: Push target mismatch!"
        echo "  Expected: $EXPECTED_REMOTE"
        echo "  Would push to: $EXPECTED_PUSH_TARGET"
        echo ""
        echo "Fix: git branch --set-upstream-to=$EXPECTED_REMOTE"
        exit 1
    fi
fi

# Prevent pushing to protected branches
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "dev" ]]; then
    echo "ERROR: Direct push to $CURRENT_BRANCH is not allowed!"
    echo "Create a feature branch and use PR workflow."
    exit 1
fi

exit 0
```

## post-checkout Hook

```bash
#!/bin/bash
set -e

# Update session if branch changed
if [ -f ".sdp/session.json" ]; then
    NEW_BRANCH=$(git branch --show-current)
    jq --arg branch "$NEW_BRANCH" '.expected_branch = $branch' .sdp/session.json > .sdp/session.json.tmp
    mv .sdp/session.json.tmp .sdp/session.json
fi

exit 0
```

## Installation

```bash
# Install hooks in current worktree
sdp hooks install

# Or manually
cp hooks/pre-commit .git/hooks/
cp hooks/pre-push .git/hooks/
cp hooks/post-checkout .git/hooks/
chmod +x .git/hooks/*
```
