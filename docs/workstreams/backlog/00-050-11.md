---
ws_id: 00-050-11
parent: sdp-79u
feature: F050
status: backlog
size: MEDIUM
project_id: 00
---

## WS-00-050-11: Multi-Agent Orchestrator (Adaptive Parallelism)

### üéØ Goal

Implement simplified multi-agent execution with adaptive parallelism. Enable @oneshot to execute all workstreams autonomously with wave-based parallelism.

**What must WORK after completing this WS:**
- Execute workstreams in waves via `bd ready`
- Adaptive agent count: 2 agents (small), 5 (medium), 10 (large)
- Cascading failure detection (3+ consecutive failures)
- Checkpoint save/restore for resume capability
- `sdp oneshot <feature>` executes all workstreams autonomously

**Acceptance Criteria:**
- [ ] AC1: Workstreams executed in waves (via bd ready)
- [ ] AC2: Adaptive agent count based on feature size
- [ ] AC3: Cascading failure detection (3+ consecutive failures)
- [ ] AC4: Checkpoint saved after each workstream
- [ ] AC5: Resume capability works (--resume flag)
- [ ] AC6: `sdp oneshot <feature>` executes autonomously
- [ ] Coverage ‚â• 80%

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### üìã Contracts

**Technical Constraints:**
- Must delegate dependency resolution to `bd ready`
- Must use wave-based parallelism (execute ready tasks, wait, repeat)
- Must detect cascading failures (3+ consecutive failures)
- Must integrate with checkpoint system (00-050-10)

---

### üîå Interfaces

```go
package orchestrator

type FeatureSize int

const (
    Small  FeatureSize = 5   // <5 workstreams
    Medium FeatureSize = 10  // 5-15 workstreams
    Large  FeatureSize = 20  // >15 workstreams
)

type Orchestrator struct {
    featureID    string
    agentCount   int
    checkpoint   *checkpoint.Repository
    beads        *beads.Wrapper
}

func NewOrchestrator(featureID string) (*Orchestrator, error)
func (o *Orchestrator) Execute() error
func (o *Orchestrator) Resume() error
func (o *Orchestrator) executeWaves() error
func (o *Orchestrator) calculateAgentCount() int
func (o *Orchestrator) detectCascadingFailures() bool
```

---

### üìÅ Scope Files

**Implementation:**
- `internal/unified/orchestrator/executor.go`
- `internal/unified/orchestrator/wave.go`
- `internal/unified/orchestrator/failure_detector.go`
- `cmd/sdp/commands/oneshot.go`

**Tests:**
- `internal/unified/orchestrator/executor_test.go`

---

### ‚úÖ Testing

**Unit Tests:**
```bash
# Agent count calculation
TestCalculateAgentCountSmall()
TestCalculateAgentCountMedium()
TestCalculateAgentCountLarge()

# Wave execution
TestExecuteWaves()
TestExecuteWavesWithDependencies()
TestExecuteWavesWithFailures()

# Cascading failure detection
TestDetectCascadingFailures()
TestDetectCascadingFailuresBelowThreshold()

# Checkpoint integration
TestCheckpointSave()
TestCheckpointRestore()
```

**Integration Tests:**
```bash
# Full oneshot execution
sdp oneshot F01
‚úÖ Wave 1: Executing 2 tasks in parallel
  ‚úì 00-001-01 completed (2m 15s)
  ‚úì 00-001-04 completed (1m 45s)

‚úÖ Wave 2: Executing 1 task
  ‚úì 00-001-02 completed (3m 30s)

‚úÖ Wave 3: Executing 1 task
  ‚úì 00-001-03 completed (2m 50s)

‚úÖ Feature F01 completed (10m 20s total)
```

---

### üîç Verification

**Pre-build:**
- [ ] Review wave execution logic
- [ ] Verify agent count calculation
- [ ] Check cascading failure detection
- [ ] Test checkpoint integration

**Post-build:**
```bash
# Run tests
go test ./internal/unified/orchestrator/... -v -cover

# Manual integration test
sdp oneshot F01

# Interrupt and resume
# (Ctrl+C during execution)
sdp oneshot --resume F01

# Verify checkpoint
cat .sdp/checkpoints/F01.json
```

---

### üìù Notes

**Dependencies:** 00-050-03, 00-050-10

**Context:**
Simplified multi-agent orchestrator (600 LOC vs 1000 LOC Python). Recommendation from deep-thinking: "Adaptive parallelism reduces execution time for large features (10+ workstreams)."

**Key Decisions:**
- Simplified from Python (1000 LOC ‚Üí 600 LOC)
- Delegate dependency resolution to `bd ready`
- Wave-based parallelism: execute ready tasks, wait, repeat
- Adaptive agent count: 2 (small), 5 (medium), 10 (large)
- Cascading failure detection: 3+ consecutive failures

**Risks:**
- `bd ready` not installed
- Agent count calculation wrong
- Cascading failure detection false positive
- Checkpoint corruption

**Mitigations:**
- Detect `bd ready` availability
- Tune agent count thresholds
- Configure failure threshold (default: 3)
- Validate checkpoint before resume

**Wave Execution Algorithm:**
1. Query `bd ready` for available tasks
2. Assign tasks to agents (round-robin)
3. Execute tasks in parallel (goroutines)
4. Wait for all tasks to complete
5. Save checkpoint
6. Repeat from step 1 (next wave)

**Adaptive Agent Count:**
- Small (<5 workstreams): 2 agents
- Medium (5-15 workstreams): 5 agents
- Large (>15 workstreams): 10 agents

**Cascading Failure Detection:**
- Track consecutive failures
- Threshold: 3 consecutive failures
- Action: Stop execution, notify user
- Resume possible after fixing failures

**Integration with Beads:**
```bash
# Get ready tasks
bd ready --json

# Execute task
sdp build 00-001-01

# Update task status
bd update 00-001-01 --status completed
```

**Checkpoint Schema:**
```json
{
  "feature_id": "F01",
  "agent_id": "abc123xyz",
  "status": "running",
  "completed_ws": ["00-001-01", "00-001-04"],
  "current_ws": "00-001-02",
  "start_time": "2026-02-05T10:00:00Z",
  "last_update": "2026-02-05T10:30:00Z"
}
```

**Performance Expectations:**
- Small feature (5 workstreams): 10-15 minutes
- Medium feature (15 workstreams): 20-30 minutes
- Large feature (30 workstreams): 40-60 minutes
- Parallelism speedup: 2-3x vs serial execution

**Error Handling:**
- Workstream failure: Log error, continue to next wave
- Cascading failures: Stop execution, notify user
- Checkpoint load failure: Start from scratch
- Checkpoint save failure: Continue without checkpoint

**Integration with @oneshot:**
```bash
# Start oneshot
sdp oneshot F01
# Creates checkpoint, executes waves

# Interrupt (Ctrl+C)
# Checkpoint saved, can resume

# Resume
sdp oneshot --resume F01
# Loads checkpoint, continues from CurrentWS
```
