---
ws_id: 00-024-01
feature_id: F024
status: done
priority: P2
size: S
depends_on: ["00-016-04"]
---

# 00-024-01: Phase Hooks

Feature: F024 (sdp_dev-bl3s)

## Goal

Add pre/post hooks at each state machine phase transition. Hooks configured via `.sdp/pipeline-hooks.yaml` — each hook is a shell command with an `on_fail` policy (halt/warn/ignore). Enables custom quality gates without changing Go code. First step toward composable Blueprints.

## Scope Files

- `internal/orchestrate/hooks.go` — new: load config, execute hooks, handle failures
- `internal/orchestrate/hooks_test.go` — test cases
- `internal/orchestrate/cli.go` — wire pre/post-ci hooks in AdvanceCIPhase
- `internal/orchestrate/loop.go` — wire pre/post hooks for opencode flow
- `cmd/sdp-orchestrate/main.go` — wire pre/post hooks in advance and review paths
- `docs/ws-verdicts/00-024-01.json` — verdict file
- `docs/workstreams/backlog/00-024-01.md` — scope update for wiring files

## Acceptance Criteria

- [x] `.sdp/pipeline-hooks.yaml` loaded at orchestrator start
- [x] Hooks fire at: pre-build, post-build, pre-review, post-review, pre-ci, post-ci
- [x] Each hook entry: `phase`, `when` (pre/post), `command`, `on_fail` (halt/warn/ignore)
- [x] `halt` → abort pipeline, exit non-zero
- [x] `warn` → log warning, continue
- [x] `ignore` → swallow failure, continue
- [x] Missing config file → no hooks (graceful degradation)
- [x] Hook stdout/stderr captured in run log
- [x] Hook timeout: 60s default, configurable per hook
- [x] Test: pre-build hook halt, post-build hook warn, missing config

## Out of Scope

- Hook marketplace / sharing
- Composable Blueprint YAML (future — this is the foundation)
- Conditional hooks (e.g., "only on feature branches")

## Implementation Notes

Config format:

```yaml
hooks:
  - phase: build
    when: post
    command: "sdp guard --ws ${WS_ID}"
    on_fail: halt
    timeout: 30
  - phase: review
    when: pre
    command: "./scripts/security-scan.sh"
    on_fail: warn
```

Environment variables available to hooks: `$WS_ID`, `$FEATURE_ID`, `$PHASE`, `$CHECKPOINT_PATH`.

~200 LOC for the hooks engine.

Research: [Stripe Minions Comparison](../../plans/2026-02-23-stripe-minions-comparison.md)

---

### Review Results

**Reviewed by:** Cursor /review
**Date:** 2026-02-23

| # | Check | Status | Notes |
|---|-------|--------|-------|
| 0 | Goal Achieved | PASS | All 10 AC met; ac_evidence in docs/ws-verdicts/00-024-01.json |
| 1 | Tests pass | PASS | `go test ./internal/orchestrate/...` |
| 2 | Coverage | N/A | orchestrate 49%; project-wide pre-existing |
| 3 | Regression | PASS | All orchestrate tests pass |
| 4 | Linters (go vet) | PASS | `go vet ./internal/orchestrate/...` |
| 5 | Type hints | N/A | Go (typed) |
| 6 | No TODO/FIXME | PASS | None in scope files |
| 7 | File size < 200 LOC | WARN | main.go 233 LOC (pre-existing + ~30 hook wiring); hooks.go 119, cli 200, loop 111 |
| 8 | Clean Architecture | PASS | Hooks in orchestrate pkg; CLI wires only |
| 9 | Docstrings | PASS | LoadHookConfig, RunHooks, HookEntry documented |
| 10 | Type annotations | N/A | Go |
| 11 | Execution Report | PASS | Verdict APPROVED; PR #55 merged |

**Verdict:** APPROVED — Phase hooks implemented; hooks engine ~120 LOC; wiring in main/loop/cli. File size warn on main.go is project-wide pattern.
