# Workstream 00-053-07: Update @review Skill

**Feature:** F053 - Component Contract Validation
**Issue:** sdp-ie25.8
**Project ID:** 00
**Status:** Pending
**Priority:** P1

## Overview

Update the @review skill to add automated contract compliance checks. This ensures implementation matches the agreed contract before feature is approved.

## Problem Statement

Current @review workflow checks:
- Code quality
- Test coverage
- Documentation
- Architecture compliance

**Missing:**
- Contract compliance validation
- Integration point verification
- Frontend-backend alignment
- SDK-backend alignment

## Solution

Add Phase 6: Contract Validation to @review skill:
1. Run contract validation agent (WS 00-053-03)
2. Verify contract still matches lock (WS 00-053-06)
3. Check validation report for errors
4. Reject review if contract violations found
5. Require fixes before approval

## Acceptance Criteria

1. **@review skill updated** at `.claude/skills/review/SKILL.md`
2. New Phase 6: Contract Validation
3. Runs `sdp contract validate` (WS 00-053-03)
4. Runs `sdp contract verify` (WS 00-053-06)
5. Checks validation report:
   - Zero ERROR-level issues
   - Zero WARNING-level issues (or documented exceptions)
6. Rejects review if:
   - Contract mismatch detected
   - Endpoint mismatches found
   - Schema incompatibilities found
7. Updates review checklist:
   - [ ] Contract validation passed
   - [ ] No endpoint mismatches
   - [ ] No schema incompatibilities
   - [ ] All integration points verified
8. Updates documentation with contract validation examples

## Scope

### In Scope
- @review skill modification
- Phase 6 addition
- Contract validation integration
- Review checklist update
- Documentation updates

### Out of Scope
- Contract validation agent (WS 00-053-03)
- Contract lock command (WS 00-053-06)

## Implementation Approach

### Phase 1: Read Current @review
1. Read `.claude/skills/review/SKILL.md`
2. Understand current phases (1-5)
3. Identify insertion point for Phase 6

### Phase 2: Add Phase 6
1. Add new section after Phase 5
2. Define steps:
   - Run contract validation
   - Verify contract lock
   - Check validation report
   - Reject if violations found
3. Update phase count

### Phase 3: Update Checklist
1. Add contract validation items
2. Mark as blocking (must pass for approval)
3. Add severity levels:
   - ERROR: Blocks review
   - WARNING: Blocks review unless exception documented

### Phase 4: Update Documentation
1. Add example review with contract validation
2. Add error handling examples
3. Update review decision tree

## Dependencies

**UPSTREAM:**
- WS 00-053-03 (Contract validation agent)
- WS 00-053-06 (Contract verify command)

**DOWNSTREAM:**
- None (this is integration work)

## Testing

### Integration Test
- Run @review on feature with contract
- Verify Phase 6 executes
- Verify validation called
- Verify reject on mismatch
- Verify approve on match

### Manual Test
- Create feature with contract violation
- Run @review
- Verify rejected with clear error

## Quality Gates

- Skill file < 200 LOC
- Clear instructions for AI agent
- Example output included
- Documentation updated

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Phase 6 added to @review skill
- [ ] Contract validation integrated
- [ ] Review checklist updated
- [ ] Documentation updated
- [ ] Integration test passes
- [ ] Example review with contract violation

## Notes

**Workflow Change:**

**Before:**
```
@review → Quality checks → Architecture → Tests → Docs → APPROVED
```

**After:**
```
@review → Quality checks → Architecture → Tests → Docs
         ↓
         Phase 6: Contract Validation
         ↓
         1. Run contract validation
         2. Verify contract lock
         3. Check validation report
         4. Reject if violations found
         ↓
         APPROVED (only if contract compliant)
```

**Review Decision Logic:**
```python
if contract_validation.errors > 0:
    return REJECT(
        reason="Contract validation failed",
        errors=contract_validation.errors,
        fix="Fix endpoint mismatches or update contract"
    )

if contract_validation.warnings > 0:
    # Allow if documented exceptions
    if has_documented_exceptions():
        return APPROVE_WITH_WARNINGS(
            warnings=contract_validation.warnings,
            exceptions=load_exceptions()
        )
    else:
        return REJECT(
            reason="Contract warnings without exceptions",
            warnings=contract_validation.warnings,
            fix="Document exceptions or fix schemas"
        )

return APPROVE()
```

**Example Review Output:**

**PASSED:**
```
✓ Phase 1: Quality Gates
✓ Phase 2: Architecture Review
✓ Phase 3: Test Coverage
✓ Phase 4: Documentation
✓ Phase 5: Security & Performance
✓ Phase 6: Contract Validation
  ✓ Contract matches lock (sha: abc123)
  ✓ No endpoint mismatches
  ✓ No schema incompatibilities

Review Result: APPROVED ✅
```

**FAILED:**
```
✓ Phase 1: Quality Gates
✓ Phase 2: Architecture Review
✓ Phase 3: Test Coverage
✓ Phase 4: Documentation
✓ Phase 5: Security & Performance
✗ Phase 6: Contract Validation
  ✗ Contract mismatch detected!
  ✗ 2 endpoint mismatches found:
    - Frontend: POST /api/telemetry/submit
      Backend: POST /api/telemetry/events
      Location: src/app/api.ts:42 vs src/api/routes.go:108
  ✗ 1 schema incompatibility:
    - SDK submit() missing required field: timestamp
      Location: src/sdk/client.py:25

Review Result: REJECTED ❌
Required fixes:
1. Align frontend endpoint with backend (or update contract)
2. Add timestamp field to SDK submit() method
3. Re-run contract validation
4. Re-submit for review
```

**Critical Insight:** This is the FINAL quality gate. Without this, contract violations slip through to production.

## Execution Report Template

```
**Started:** [Timestamp]
**Completed:** [Timestamp]
**Duration:** Xm

**Files Modified:**
- .claude/skills/review/SKILL.md (MODIFIED)
  - Added Phase 6: Contract Validation
  - Updated review checklist
  - Added example output
  - X lines added, Y lines removed

**Test Results:**
- Integration test: PASSED
- Manual test: PASSED
- @review rejects contract violations: YES
- @review approves compliant features: YES

**Challenges:**
- [Any issues encountered]

**Follow-up Work:**
- [None - this is integration work]
```
