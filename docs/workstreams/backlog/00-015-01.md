---
ws_id: 00-015-01
feature_id: F015
status: done
priority: P0
size: S
depends_on: ["00-014-01"]
---

# 00-015-01: Stop Hook — Cursor Implementation

Feature: F015 (sdp_dev-jt9x)

## Goal

Stop hook for Cursor that prevents the agent from exiting when the oneshot CI phase is incomplete. Reads checkpoint, blocks if needed.

## Scope Files

- `scripts/oneshot-stop-gate.sh` — stop hook script
- `.cursor/hooks.json` — hook configuration (or `.cursor/settings.json` hooks section)

## Acceptance Criteria

- [x] Hook fires when Cursor agent finishes a response
- [x] Reads `.sdp/checkpoints/F*.json` — finds active feature checkpoint
- [x] If `pr_number` is set AND (`last_phase != "ci"` OR `last_state != "ok"`): exit 2 (block)
- [x] Block message: "CI phase incomplete. Run: sdp ci-loop --pr {N} --feature F{NNN}"
- [x] If no active checkpoint OR CI phase complete: exit 0 (allow)
- [x] Handles `stop_hook_active` flag to prevent infinite loops
- [x] Test: agent tries to stop before CI → blocked; agent stops after CI green → allowed

## Out of Scope

- Claude Code integration (that's 00-015-02)
- Auto-fix (handled by sdp ci-loop)

## Implementation Notes

- Hook receives JSON payload on stdin with `session_id`, `stop_hook_active`, `transcript_path`
- When `stop_hook_active == true`, allow stop (prevent infinite block loop)
- Parse checkpoint with `jq`: `.phase`, `.pr_number`, last event in run file
- Keep the script under 50 lines — simple gate logic

## Usage in Cursor

```json
{
  "hooks": {
    "Stop": [{
      "type": "command",
      "command": "scripts/oneshot-stop-gate.sh"
    }]
  }
}
```

Agent writes code → tries to stop → hook checks checkpoint → blocks if CI incomplete → agent sees "run sdp ci-loop" → runs it → CI goes green → checkpoint updated → next stop attempt → hook allows.
