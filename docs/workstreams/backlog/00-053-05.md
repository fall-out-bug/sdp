---
ws_id: "00-053-05"
feature_id: "F053"
title: "Workstream 00-053-05: Implement `sdp contract synthesize` CLI"
status: backlog
priority: 2
size: MEDIUM
depends_on: []
blocks: []
---

# Workstream 00-053-05: Implement `sdp contract synthesize` CLI

**Feature:** F053 - Component Contract Validation
**Issue:** sdp-ie25.6
**Project ID:** 00
**Status:** Pending
**Priority:** P1

## Overview

Implement the `sdp contract synthesize` CLI command that calls the contract synthesis agent. This provides a user-friendly interface for contract synthesis.

## Problem Statement

Contract synthesis agent (WS 00-053-00) exists but no way to call it from command line. Users need:
- Simple CLI command
- Feature name input
- Progress feedback
- Error handling
- Result display

## Solution

Add `contract synthesize` subcommand to SDP CLI:
```bash
sdp contract synthesize --feature=telemetry
```

## Acceptance Criteria

1. **CLI command** implemented in `src/sdp/cli/contract_commands.go`
2. Subcommand: `sdp contract synthesize`
3. Required flag: `--feature` (feature name)
4. Optional flags:
   - `--requirements` (path to requirements file, default: `docs/drafts/{feature}-requirements.md`)
   - `--output` (output path, default: `.contracts/{feature}.yaml`)
5. Progress feedback:
   - "Analyzing requirements..."
   - "Proposing contract..."
   - "Requesting agent reviews..."
   - "Synthesizing feedback..."
   - "Contract agreed: .contracts/{feature}.yaml"
6. Error handling:
   - Requirements file not found
   - Synthesis failure
   - Agent timeout
7. Exit codes:
   - 0: Success
   - 1: Requirements not found
   - 2: Synthesis failed
   - 3: Conflict unresolved (escalated to human)

## Scope

### In Scope
- CLI command implementation
- Flag parsing
- Progress feedback
- Error handling
- Integration with synthesis agent (WS 00-053-00)

### Out of Scope
- Synthesis agent implementation (WS 00-053-00)
- Contract lock command (WS 00-053-06)

## Implementation Approach

### Phase 1: CLI Structure
1. Create `src/sdp/cli/contract_commands.go`
2. Define `SynthesizeCmd` struct
3. Add cobra command:
   ```go
   var contractCmd = &cobra.Command{
       Use:   "contract",
       Short: "Manage API contracts",
       Run:   runContractHelp,
   }
   var synthesizeCmd = &cobra.Command{
       Use:   "synthesize [flags]",
       Short: "Synthesize contract from multi-agent agreement",
       Run:   runContractSynthesize,
   }
   ```

### Phase 2: Flag Parsing
1. Add `--feature` flag (required)
2. Add `--requirements` flag (optional)
3. Add `--output` flag (optional)
4. Validate flags

### Phase 3: Agent Integration
1. Import synthesis agent (WS 00-053-00)
2. Call `agent.Synthesize(feature, requirementsPath)`
3. Handle result

### Phase 4: Progress & Errors
1. Print progress messages
2. Print success message with output path
3. Print error messages with context
4. Set appropriate exit codes

## Dependencies

**UPSTREAM:**
- WS 00-053-00 (Contract synthesis agent)

**DOWNSTREAM:**
- WS 00-053-06 (Lock command uses synthesized contract)

## Testing

### Unit Tests
- `TestSynthesizeCmd_FlagParsing`
- `TestSynthesizeCmd_MissingFeatureFlag`
- `TestSynthesizeCmd_RequirementsNotFound`

### Integration Tests
- `TestEndToEnd_SynthesizeCommand`
- Run command on sample requirements
- Verify contract generated
- Verify exit codes

## Quality Gates

- Files < 200 LOC
- Cyclomatic complexity < 10
- Test coverage ≥ 80%
- No bare exceptions
- Full type hints

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tests passing
- [ ] Coverage ≥ 80%
- [ ] Integration test passes
- [ ] CLI help text clear
- [ ] Error messages helpful

## Notes

**CLI Usage:**
```bash
# Basic usage
sdp contract synthesize --feature=telemetry

# Custom requirements path
sdp contract synthesize --feature=telemetry --requirements=docs/requirements/telemetry.md

# Custom output path
sdp contract synthesize --feature=telemetry --output=.contracts/telemetry-v2.yaml
```

**Progress Output:**
```
$ sdp contract synthesize --feature=telemetry
✓ Analyzing requirements from docs/drafts/telemetry-requirements.md
✓ Proposing initial contract
✓ Requesting frontend agent review...
✓ Requesting backend agent review...
✓ Requesting SDK agent review...
✓ Synthesizing feedback...
✓ Contract agreed: .contracts/telemetry.yaml

Contract Summary:
- Endpoints: 5
- Schemas: 8
- Conflicts resolved: 2
- Resolution method: Domain expertise veto
```

**Error Handling:**
```
$ sdp contract synthesize --feature=missing
✗ Requirements file not found: docs/drafts/missing-requirements.md

$ sdp contract synthesize --feature=conflict
✗ Synthesis failed: Unresolved conflict
  Frontend: POST /api/telemetry/submit
  Backend: POST /api/telemetry/events
  Escalated to human: Please resolve in .contracts/conflict-resolution.md
```

## Execution Report Template

```
**Started:** [Timestamp]
**Completed:** [Timestamp]
**Duration:** Xm

**Files Modified:**
- src/sdp/cli/contract_commands.go (NEW, X LOC)
- src/sdp/cli/contract_commands_test.go (NEW, Y LOC)

**Test Results:**
- Unit tests: X/Y passing
- Integration tests: A/B passing
- Coverage: Z%

**CLI Commands:**
- sdp contract synthesize: IMPLEMENTED
- Flags: --feature, --requirements, --output
- Progress feedback: YES
- Error handling: YES

**Challenges:**
- [Any issues encountered]
```
