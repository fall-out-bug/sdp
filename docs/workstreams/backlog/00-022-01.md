---
ws_id: 00-022-01
feature_id: F022
status: done
priority: P1
size: S
depends_on: ["00-016-04"]
---

# 00-022-01: Context Pre-Hydration

Feature: F022 (sdp_dev-bdwr)

## Goal

Deterministically gather all context before LLM invocation. Write `.sdp/context-packet.json` so the agent starts with complete, verified information — no tool calls needed to understand the task. Directly attacks #1 reliability problem (context degradation in long sessions).

Inspired by Stripe's deterministic MCP pre-hydration pattern.

## Scope Files

- `internal/orchestrate/hydrate.go` — gather context, write packet
- `internal/orchestrate/hydrate_parse.go` — parse WS sections, deps, quality gates
- `internal/orchestrate/hydrate_sources.go` — git/bd helpers
- `internal/orchestrate/loop.go` — wire hydrate before each LLM invoke
- `internal/orchestrate/invoke_opencode.go` — read context packet, inject into prompt

## Acceptance Criteria

- [x] `sdp orchestrate --hydrate` writes `.sdp/context-packet.json` before every LLM invocation
- [x] Packet contains: WS spec, acceptance criteria, scope files list, drift status, checkpoint state, dependency status, quality gate results
- [x] Each field sourced deterministically (file read, git status, bd show — no LLM)
- [x] Packet is JSON Schema validated before use
- [x] LLM prompt includes packet contents (not a file reference — full injection)
- [x] Hydration failure blocks LLM invocation (fail-safe)
- [x] Test: packet contents match expected for a sample workstream

## Out of Scope

- Scope enforcement at runtime (that's F023)
- Phase hooks (that's F024)
- Prompt template changes beyond injecting the packet

## Implementation Notes

Context sources to gather:
| Source | Method | Field |
|--------|--------|-------|
| WS spec | Read `docs/workstreams/backlog/{ws_id}.md` | `workstream` |
| Acceptance criteria | Parse from WS spec | `acceptance_criteria` |
| Scope files | Parse from WS spec + `git ls-files` verify | `scope_files` |
| Checkpoint | Read `.sdp/checkpoints/F{NNN}.json` | `checkpoint` |
| Dependencies | `bd show` for each dep in WS frontmatter | `dependencies` |
| Quality gates | Parse AGENTS.md quality gates section | `quality_gates` |
| Git status | `git status --porcelain` | `drift_status` |

Research: [Stripe Minions Comparison](../../plans/2026-02-23-stripe-minions-comparison.md)

---

### Review Results

**Reviewed by:** Cursor (reviewer agent)
**Date:** 2026-02-23

| # | Check | Status | Notes |
|---|-------|--------|-------|
| 0 | Goal Achieved | PASS | All 7 AC checked |
| 1 | Tests pass | PASS | `go test ./internal/orchestrate/...` |
| 2 | Coverage | N/A | Project-wide 39.7% (pre-existing) |
| 3 | Regression | PASS | All orchestrate tests pass |
| 4 | Linters | PASS | `go vet ./internal/orchestrate/...` |
| 5 | Type hints | N/A | Go (typed) |
| 6 | No TODO/FIXME | PASS | None in scope files |
| 7 | File size | PASS | hydrate.go 160 LOC, hydrate_parse 71, hydrate_sources 67 |
| 8 | Clean Architecture | PASS | No infra in domain |
| 9 | Docstrings | PASS | Public funcs documented |
| 10 | Type annotations | N/A | Go |
| 11 | Execution Report | PASS | AC evidence in WS |

**Verdict:** APPROVED — All checks pass after splitting hydrate.go into hydrate_parse.go and hydrate_sources.go.
