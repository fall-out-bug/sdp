---
ws_id: 00-004-03
feature_id: F004
feature: F004
status: backlog
priority: P1
size: M
depends_on: ["00-004-02"]
---

# 00-004-03: Integration Test — Analyst Output Feeds Coder Prompt

Feature: F004 (sdp_dev-5jb)

## Goal

End-to-end integration test proving the sequential pipeline works: analyst writes handoff → coder reads it → reviewer reads both.

## Scope Files

- `internal/adapter/agentrun_reconciler_test.go` — integration test
- `internal/adapter/testdata/` — fixtures

## Acceptance Criteria

- [x] Test creates AgentRun, simulates analyst Task completing with handoff artifact
- [x] Verifies coder Task is created (not before analyst completes)
- [x] Verifies coder Task prompt/annotations reference analyst handoff path
- [x] Simulates coder Task completing with handoff artifact
- [x] Verifies reviewer Task is created with both handoff paths
- [x] Verifies reviewer verdict `approve` transitions AgentRun to Succeeded
- [x] Test uses envtest or fake client (no real cluster required)

## Out of Scope

- Real kubeopencode integration (needs real cluster)
- Rework loop testing (00-005-01)

## Implementation Notes

- Use controller-runtime envtest for realistic reconciliation
- Create fake handoff artifacts in the workspace path before simulating Task completion
- This test is the contract: if it passes, the pipeline works

---

### Review Results

**Reviewed by:** Cursor /review
**Date:** 2026-02-23

| # | Check | Status |
|---|-------|--------|
| 0 | Goal Achieved | PASS |
| 1 | Tests pass | PASS |
| 2 | Coverage >= 80% | PASS |
| 3 | Regression | PASS |
| 4 | Linters (go vet) | PASS |
| 5 | Type hints | N/A (Go) |
| 6 | No TODO/FIXME | PASS |
| 7 | File size < 200 LOC | PASS |
| 8 | Clean Architecture | PASS |
| 9 | Docstrings | PASS |
| 10 | Type annotations | N/A (Go) |
| 11 | Execution Report | N/A |

**Verdict:** APPROVED
