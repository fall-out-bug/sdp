---
ws_id: 00-066-02
feature_id: F066
title: "Shell Fallbacks: Core Commands"
status: backlog
priority: 0
depends_on: [00-066-01]
blocks: [00-066-04]
project_id: sdp
---

## Goal

Create shell fallbacks for core CLI commands that enable graceful degradation.

## Context

Part of F066 Protocol/Prompts Separation. Shell fallbacks allow prompts to work when Go CLI is unavailable.

## Acceptance Criteria

- [ ] AC1: `scripts/sdp-guard-check.sh` - Basic git context validation
- [ ] AC2: `scripts/sdp-drift-detect.sh` - Simple scope file check
- [ ] AC3: `scripts/sdp-context-recover.sh` - Worktree recovery from git
- [ ] AC4: All scripts exit with proper codes (0=ok, 1=error)
- [ ] AC5: Scripts are POSIX-compatible (no bashisms)

## Scope Files

```yaml
scope_files:
  - scripts/sdp-guard-check.sh      # NEW
  - scripts/sdp-drift-detect.sh     # NEW
  - scripts/sdp-context-recover.sh  # NEW
  - scripts/sdp-common.sh           # NEW - shared functions
```

## Implementation Notes

### sdp-guard-check.sh

```bash
#!/bin/sh
# Fallback for: sdp guard context check
# Validates git context without full session validation

set -e

# Check we're in a git repo
git rev-parse --git-dir > /dev/null 2>&1 || {
    echo "ERROR: Not in a git repository"
    exit 1
}

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check for feature branch pattern
case "$BRANCH" in
    feature/*|bugfix/*|hotfix/*)
        echo "OK: On feature branch: $BRANCH"
        exit 0
        ;;
    dev|develop|main|master)
        echo "WARNING: On protected branch: $BRANCH"
        echo "Consider creating a feature branch"
        exit 0
        ;;
    *)
        echo "OK: On branch: $BRANCH"
        exit 0
        ;;
esac
```

### sdp-drift-detect.sh

```bash
#!/bin/sh
# Fallback for: sdp drift detect
# Simple scope file existence check

set -e

WS_ID="$1"
if [ -z "$WS_ID" ]; then
    echo "USAGE: sdp-drift-detect.sh <ws-id>"
    exit 1
fi

# Find workstream file
WS_FILE=$(find docs/workstreams -name "${WS_ID}.md" 2>/dev/null | head -1)

if [ -z "$WS_FILE" ]; then
    echo "ERROR: Workstream file not found: $WS_ID"
    exit 1
fi

# Extract scope files (simple grep)
SCOPE_FILES=$(grep -A 20 "scope_files:" "$WS_FILE" | grep "  - " | sed 's/  - //')

if [ -z "$SCOPE_FILES" ]; then
    echo "WARNING: No scope_files defined in $WS_FILE"
    exit 0
fi

# Check each file exists
ERRORS=0
for FILE in $SCOPE_FILES; do
    if [ -f "$FILE" ]; then
        echo "OK: $FILE exists"
    else
        echo "ERROR: $FILE not found"
        ERRORS=$((ERRORS + 1))
    fi
done

if [ $ERRORS -gt 0 ]; then
    echo "FAIL: $ERRORS file(s) missing"
    exit 1
fi

echo "PASS: All scope files exist"
exit 0
```

### sdp-common.sh

```bash
#!/bin/sh
# Shared functions for shell fallbacks

# Check if Go CLI is available
has_sdp_cli() {
    command -v sdp > /dev/null 2>&1
}

# Run CLI or fallback
run_sdp_or_fallback() {
    CMD="$1"
    shift
    ARGS="$@"

    if has_sdp_cli; then
        sdp "$CMD" $ARGS
    else
        # Source and run fallback
        SCRIPT_DIR=$(dirname "$0")
        . "$SCRIPT_DIR/sdp-common.sh"
        "fallback_$CMD" $ARGS
    fi
}

# Find project root
find_project_root() {
    DIR=$(pwd)
    while [ "$DIR" != "/" ]; do
        if [ -f "$DIR/.beads" ] || [ -d "$DIR/docs" ]; then
            echo "$DIR"
            return 0
        fi
        DIR=$(dirname "$DIR")
    done
    echo "."
}
```

## Definition of Done

- [ ] All AC met
- [ ] Scripts tested without CLI installed
- [ ] Scripts are POSIX-compatible (test with dash)
