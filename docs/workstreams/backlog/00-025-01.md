---
ws_id: 00-025-01
feature_id: F025
status: done
priority: P2
size: S
depends_on: []
---

# 00-025-01: Prompt Consolidation

Feature: F025 (sdp_dev-h7qu)

## Goal

Consolidate 5 scattered prompt-building functions into one package `internal/prompt/sections.go`. Extract shared sections (TaskSection, BoundarySection, EvidenceSection) as testable pure functions. DRY without abstraction tax — no framework, just shared functions.

## Scope Files

- `internal/prompt/sections.go` — new: shared prompt section builders
- `internal/prompt/sections_test.go` — golden-file tests
- `internal/prompt/testdata/acceptance_criteria_section.golden`
- `internal/prompt/testdata/boundary_section.golden`
- `internal/prompt/testdata/evidence_section.golden`
- `internal/prompt/testdata/scope_files_section.golden`
- `internal/prompt/testdata/task_section.golden`
- `internal/prompt/testdata/task_section_review.golden`
- `internal/llm/prompt.go` — refactor to use shared sections
- `internal/orchestrate/invoke_opencode.go` — refactor to use shared sections
- `internal/orchestrate/hydrate.go` — FormatForPrompt uses shared sections
- `internal/roles/reviewer.go` — refactor to use shared sections

## Acceptance Criteria

- [x] All prompt-building logic consolidated into `internal/prompt/` package
- [x] `TaskSection(ws WorkstreamSpec) string` — renders task description + acceptance criteria
- [x] `BoundarySection(ws WorkstreamSpec) string` — renders scope files + out-of-scope
- [x] `EvidenceSection(checkpoint Checkpoint) string` — renders evidence context
- [x] Each section function is a pure function (no side effects, no file I/O)
- [x] Golden-file tests for each section (expected output checked in as `.golden` files)
- [x] Callers (`invoke_opencode.go`, `prompt.go`, `reviewer.go`) refactored to use shared sections
- [x] Net LOC likely decreases or stays flat
- [x] No behavioral changes — prompts rendered identically before and after

## Out of Scope

- Prompt templating engine / DSL
- Dynamic prompt generation based on context (that's context pre-hydration, F022)
- Prompt provenance recording (that's F026)

## Implementation Notes

Current prompt builders found in:
1. `internal/llm/prompt.go` — `BuildPrompt()`: concatenates task + boundary
2. `internal/orchestrate/invoke_opencode.go` — inline `fmt.Sprintf` for @build, @review
3. `internal/roles/reviewer.go` — `buildReviewPrompt()`: persona + checklist
4. `internal/orchestrate/state_machine.go` — phase-specific prompt fragments
5. `internal/agent/skills.go` — skill injection into prompts

Pattern: extract shared sections, keep caller-specific assembly. No abstraction layer — just functions.

Research: [Prompt Provenance Design](../../plans/2026-02-23-prompt-provenance-design.md)

---

## Review Results

**Reviewed by:** Cursor (review command)
**Date:** 2026-02-23

| # | Check | Status |
|---|-------|--------|
| 0 | Goal Achieved | PASS |
| 1 | Tests pass | PASS |
| 2 | Coverage (F025 scope) | PASS |
| 3 | Regression | PASS |
| 4 | Linters (go vet) | PASS |
| 5 | Type hints | PASS |
| 6 | No TODO/FIXME | PASS |
| 7 | File size (< 200 LOC) | PASS |
| 8 | Clean Architecture | PASS |
| 9 | Docstrings on public functions | PASS |
| 10 | AC verified | PASS |
| 11 | No partial implementation | PASS |

**Verdict:** APPROVED
