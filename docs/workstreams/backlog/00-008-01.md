---
ws_id: 00-008-01
feature_id: F008
status: backlog
priority: P2
size: M
depends_on: []
---

# 00-008-01: Wire Model-Policy ConfigMap into AgentRunReconciler

Feature: F008 (sdp_dev-9661)

## Goal

AgentRunReconciler resolves model from the existing `model-policy` ConfigMap based on workstream role. Writes resolved model to AgentRun status for audit.

## Scope Files

- `internal/adapter/agentrun_reconciler.go` — add model resolution
- `internal/policy/config.go` — existing, wire into reconciler
- `api/v1alpha1/agentrun_types.go` — add `Status.ResolvedModel`
- `deploy/k8s/control/model-policy.yaml` — existing ConfigMap

## Acceptance Criteria

- [ ] If `spec.model` is empty, resolve from `spec.workstream` → role → ConfigMap policy
- [ ] `status.resolvedModel` set on AgentRun after resolution
- [ ] Resolved model passed to Task CRD via `spec.agentRef.model` or env var
- [ ] PolicyGate allowlist check before Task creation
- [ ] Test: AgentRun with empty model → resolved from ConfigMap
- [ ] Test: AgentRun with explicit model → uses that model (override)

## Out of Scope

- Budget tracking (00-008-02)
- Per-project model overrides

## Implementation Notes

- `policy.RoleDefaultModel(role)` already exists — just call it in the reconciler
- Mount `model-policy` ConfigMap into adapter-controller pod (may already be done)
- Consider adding annotation-based override: `sdp.dev/model-override`
