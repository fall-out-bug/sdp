---
ws_id: 00-004-02
feature_id: F004
feature: F004
status: backlog
priority: P1
size: M
depends_on: ["00-004-01"]
---

# 00-004-02: Inject Handoff Paths into Task CRD Annotations

Feature: F004 (sdp_dev-45l)

## Goal

When creating coder and reviewer Tasks, inject the path to previous role's handoff artifact via Task CRD annotations. The agent prompt template reads these paths.

## Scope Files

- `internal/adapter/agentrun_reconciler.go` — add annotation injection
- `internal/adapter/intent_translator.go` — read annotations into prompt
- `internal/adapter/workspace.go` — handoff file path resolution

## Acceptance Criteria

- [x] Coder Task has annotation `sdp.dev/handoff-analyst: .sdp/handoff/<issueID>/analyst.json`
- [x] Reviewer Task has annotations for both analyst and coder handoff paths
- [x] IntentTranslator includes handoff content in the agent prompt
- [x] Agent prompt instructs the role to read handoff file and act on it
- [x] Test: coder Task annotation contains correct path after analyst completes

## Out of Scope

- The agent actually writing the handoff file (that's an opencode skill/prompt concern)
- Rework loop (00-005-01)

## Implementation Notes

- Handoff files live at `.sdp/handoff/<issueID>/<role>.json` in the shared workspace
- The agent must be instructed (via system prompt or AGENTS.md) to write its handoff file at the expected path
- Consider adding a `WorkspaceResolver.HandoffPath(issueID, role)` helper

---

### Review Results

**Reviewed by:** Cursor /review
**Date:** 2026-02-23

| # | Check | Status |
|---|-------|--------|
| 0 | Goal Achieved | PASS |
| 1 | Tests pass | PASS |
| 2 | Coverage >= 80% | PASS |
| 3 | Regression | PASS |
| 4 | Linters (go vet) | PASS |
| 5 | Type hints | N/A (Go) |
| 6 | No TODO/FIXME | PASS |
| 7 | File size < 200 LOC | PASS |
| 8 | Clean Architecture | PASS |
| 9 | Docstrings | PASS |
| 10 | Type annotations | N/A (Go) |
| 11 | Execution Report | N/A |

**Verdict:** APPROVED
