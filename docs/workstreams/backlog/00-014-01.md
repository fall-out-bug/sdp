---
ws_id: 00-014-01
feature_id: F014
status: done
priority: P0
size: M
depends_on: []
---

# 00-014-01: CI Loop CLI — Poll + Classify

Feature: F014 (sdp_dev-u7db)

## Goal

Deterministic Go CLI `sdp ci-loop` that polls GitHub PR checks until green or escalates. No LLM in the loop.

## Scope Files

- `cmd/sdp-ci-loop/main.go` — new CLI entry point
- `internal/ciloop/poller.go` — poll `gh pr checks`, parse PENDING/FAILURE/SUCCESS
- `internal/ciloop/classifier.go` — rule-based: Go test/build = auto-fixable, secrets/flaky = escalate

## Acceptance Criteria

- [x] `sdp ci-loop --pr 42 --feature F067 --max-iter 5` polls until all checks pass
- [x] PENDING checks → wait 60s, retry (not counted as iteration)
- [x] FAILURE checks → classify as auto-fixable or escalate
- [x] On escalate: `bd create --title="CI BLOCKED: ..." --priority=0`, exit 1
- [x] On all green: append run event (phase=ci, state=ok) to `.sdp/runs/` run file; checkpoint `phase` updated via SaveCheckpoint; exit 0
- [x] Reads `.sdp/checkpoints/F{NNN}.json` for pr_number and branch
- [x] Appends events to `.sdp/runs/` run file
- [x] Test: poll → green path, poll → failure → escalate path

## Out of Scope

- Auto-fix logic (that's 00-014-02)
- Stop hook integration (that's F015)

## Implementation Notes

- Use `gh pr checks $PR --json name,state` for status
- Use `gh run view $RUN_ID --log-failed` for failure logs
- Classification rules: `go test`, `go build`, `k8s-validate` → auto-fixable; `secrets`, `flaky` → escalate
- Exit codes: 0 = green, 1 = escalated, 2 = max iterations exceeded

## Usage

### Cursor

Agent invokes as a tool call:
```bash
sdp ci-loop --pr 42 --feature F004 --max-iter 5
```
Single tool call, blocks until done. No multi-turn loop needed.

### Claude Code

Same CLI, invoked via Shell tool. Stop hook (F015) prevents premature exit before this runs.
