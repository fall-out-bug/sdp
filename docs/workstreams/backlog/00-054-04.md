---
ws_id: "00-054-04"
feature_id: "F054"
title: "Evidence Log Writer"
status: "backlog"
priority: "P0"
depends_on: ["00-054-03"]
blocks: ["00-054-05", "00-054-07"]
project_id: "00"
---

# 00-054-04: Evidence Log Writer

## Goal

Implement append-only JSONL writer for `.sdp/log/events.jsonl` with hash chain.

## Context

Existing `internal/telemetry/collector.go` writes to `~/.config/sdp/telemetry.jsonl`. The evidence log is different:
- Lives in the **project repo** (`.sdp/log/events.jsonl`), not user home
- Uses hash chain (each event hashes previous event)
- Committed to git (not gitignored)
- Needs `.gitattributes` merge driver for concurrent appends

## Acceptance Criteria

- [ ] AC1: `evidence.Writer` creates/appends to `.sdp/log/events.jsonl`
- [ ] AC2: Each event gets `prev_hash` = SHA-256 of last line in file
- [ ] AC3: First event in file: `prev_hash` = `"genesis"`
- [ ] AC4: Atomic write: fsync after each append
- [ ] AC5: `evidence.Reader` reads and validates hash chain integrity
- [ ] AC6: Chain validation: `Verify()` returns first broken link or nil
- [ ] AC7: `.gitattributes` entry for merge driver (union merge)
- [ ] AC8: Concurrent write safety (file lock or atomic append)

## Scope Files

**Implementation:**
- sdp-plugin/internal/evidence/writer.go (new)
- sdp-plugin/internal/evidence/reader.go (new)
- sdp-plugin/internal/evidence/writer_test.go (new)
- sdp-plugin/internal/evidence/reader_test.go (new)

**Tests:**
- sdp-plugin/internal/evidence/writer_test.go
- sdp-plugin/internal/evidence/reader_test.go

## Key Design

```go
type Writer struct {
    path     string
    mu       sync.Mutex
    lastHash string
}

func (w *Writer) Append(event Event) error {
    w.mu.Lock()
    defer w.mu.Unlock()
    event.PrevHash = w.lastHash
    data, _ := json.Marshal(event)
    hash := sha256.Sum256(data)
    // atomic append with fsync
    w.lastHash = hex.EncodeToString(hash[:])
    return appendToFile(w.path, data)
}
```

## Verification

```bash
cd sdp-plugin && go test ./internal/evidence/... -v -cover -race
# Race detector ON — concurrent safety matters
# Coverage >= 80%
```

## Notes

- ~2h work
- Reuse patterns from telemetry/collector.go but NOT the code itself
- Evidence goes to project root, telemetry goes to user home — different concerns
- `.gitattributes`: `*.jsonl merge=union` for the evidence log
