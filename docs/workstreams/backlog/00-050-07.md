---
ws_id: 00-050-07
parent: sdp-79u
feature: F050
status: backlog
size: MEDIUM
project_id: 00
---

## WS-00-050-07: Telemetry Collector

### üéØ Goal

Auto-capture execution metrics (git stats, coverage, friction). Enable zero-friction telemetry collection by appending data to workstream frontmatter automatically.

**What must WORK after completing this WS:**
- Capture files changed, LOC added/deleted from git
- Capture test coverage before/after implementation
- Detect friction points (quality failures, missing type hints)
- Append telemetry to workstream frontmatter automatically
- `sdp telemetry scan` generates metrics summary

**Acceptance Criteria:**
- [ ] AC1: Git stats capture files changed, LOC added/deleted
- [ ] AC2: Coverage capture runs pytest --cov-report=json
- [ ] AC3: Friction detection analyzes quality cache
- [ ] AC4: Telemetry appended to workstream frontmatter
- [ ] AC5: `sdp telemetry scan <ws-id>` displays summary
- [ ] Coverage ‚â• 80%

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### üìã Contracts

**Technical Constraints:**
- Must use git subprocess commands (not libgit2)
- Must parse pytest --cov-report=json output
- Must preserve YAML frontmatter formatting
- Must detect friction points from quality cache

---

### üîå Interfaces

```go
package telemetry

type GitStats struct {
    FilesChanged []string
    LOCAdded     int
    LOCDeleted   int
    Commits      int
}

type CoverageStats struct {
    Before  float64
    After   float64
    Delta   float64
}

type FrictionPoint struct {
    Description string
    Severity    string
    Count       int
}

type Telemetry struct {
    GitStats        GitStats
    Coverage        CoverageStats
    FrictionPoints  []FrictionPoint
    Outcome         string
    Timestamp       time.Time
}

type Collector struct {
    workstreamPath string
}

func NewCollector(wsPath string) (*Collector, error)
func (c *Collector) Collect() (*Telemetry, error)
func (c *Collector) captureGitStats() (*GitStats, error)
func (c *Collector) captureCoverage() (*CoverageStats, error)
func (c *Collector) detectFriction() ([]FrictionPoint, error)
func (c *Collector) appendToWorkstream(t *Telemetry) error
```

---

### üìÅ Scope Files

**Implementation:**
- `internal/telemetry/collector.go`
- `internal/telemetry/git_stats.go`
- `internal/telemetry/coverage.go`
- `internal/telemetry/friction.go`
- `internal/telemetry/yaml.go`
- `cmd/sdp/commands/telemetry.go`

**Tests:**
- `internal/telemetry/collector_test.go`

---

### ‚úÖ Testing

**Unit Tests:**
```bash
# Git stats capture
TestGitStatsNoChanges()
TestGitStatsWithChanges()
TestGitStatsParseError()

# Coverage capture
TestCoverageBeforeAfter()
TestCoverageParseError()

# Friction detection
TestFrictionQualityFailures()
TestFrictionMissingTypeHints()

# Workstream append
TestAppendToWorkstream()
TestAppendPreservesFrontmatter()
```

**Integration Tests:**
```bash
# Full TDD cycle with telemetry
sdp build 00-001-01

# Workstream file automatically updated:
---
telemetry:
  files_changed: [src/module.py, tests/test_module.py]
  loc_added: 45
  loc_deleted: 12
  test_coverage_before: 0
  test_coverage_after: 87
  friction_points:
    - "Quality gate failed 2x due to missing type hints"
  outcome: "success"
---

# Scan telemetry
sdp telemetry scan 00-001-01
```

---

### üîç Verification

**Pre-build:**
- [ ] Review git command parsing logic
- [ ] Verify coverage JSON parsing
- [ ] Check YAML frontmatter preservation
- [ ] Test friction detection heuristics

**Post-build:**
```bash
# Run tests
go test ./internal/telemetry/... -v -cover

# Manual integration test
cd /tmp/test-project
../../sdp build 00-050-07

# Check workstream file
cat docs/workstreams/in_progress/00-050-07.md | grep -A 10 "telemetry:"
```

---

### üìù Notes

**Dependencies:** 00-050-04

**Context:**
Telemetry collector (600 LOC). Recommendation from deep-thinking: "Auto-capture telemetry eliminates manual documentation (zero friction) and enables pattern analysis."

**Key Decisions:**
- Git subprocess commands (not libgit2 - lighter)
- pytest --cov-report=json (standard format)
- YAML frontmatter append (human-readable)
- Friction detection from quality cache

**Risks:**
- Git commands fail (no git repo)
- Coverage JSON parsing fails
- YAML frontmatter corruption
- Friction detection false positives

**Mitigations:**
- Check git repo before collection
- Validate coverage JSON structure
- Backup workstream before append
- Tune friction detection thresholds

**Friction Detection Heuristics:**
- Quality gate failures (HIGH severity)
- Missing type hints (MEDIUM severity)
- Low coverage (<80%) (MEDIUM severity)
- Large files (>200 LOC) (LOW severity)

**Telemetry Format:**
```yaml
telemetry:
  files_changed:
    - src/module.py
    - tests/test_module.py
  loc_added: 45
  loc_deleted: 12
  test_coverage_before: 0
  test_coverage_after: 87
  friction_points:
    - description: "Quality gate failed 2x due to missing type hints"
      severity: "HIGH"
      count: 2
  outcome: "success"
  timestamp: "2026-02-05T10:30:00Z"
```
