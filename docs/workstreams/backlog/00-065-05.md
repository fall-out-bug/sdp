---
ws_id: 00-065-05
feature_id: F065
title: "Agent Prompt Constraints"
status: backlog
priority: 1
depends_on: []
blocks: []
project_id: sdp
beads_id: sdp-t13e
---

## Goal

Create git safety guidelines for agents and update skills with inline checklists.

## Context

Agents need explicit guidance on git safety. Prompts provide the first layer of defense.

**Design Reference:** docs/plans/2026-02-12-agent-git-safety-protocol.md (Section 4)

## Acceptance Criteria

- [ ] AC1: Create `.claude/GIT_SAFETY.md` with comprehensive guidelines
- [ ] AC2: Update `@build` skill with context verification checklist
- [ ] AC3: Update `@bugfix` skill with context verification checklist
- [ ] AC4: Update `@deploy` skill with context verification checklist
- [ ] AC5: Update `orchestrator.md` agent spec with context awareness
- [ ] AC6: Update `builder.md` agent spec with context awareness
- [ ] AC7: All checklists reference `sdp guard context check`

## Scope Files

```yaml
scope_files:
  - .claude/GIT_SAFETY.md                   # NEW: safety guidelines
  - .claude/skills/build/SKILL.md           # UPDATE: add checks
  - .claude/skills/bugfix/SKILL.md          # UPDATE: add checks
  - .claude/skills/deploy/SKILL.md          # UPDATE: add checks
  - .claude/agents/orchestrator.md          # UPDATE: context awareness
  - .claude/agents/builder.md               # UPDATE: context awareness
```

## GIT_SAFETY.md Content

```markdown
# Git Safety Guidelines for Agents

## CRITICAL RULES

1. **NEVER run git commands without verifying context**
2. **ALWAYS check pwd before git operations**
3. **ALWAYS verify branch before commits**
4. **NEVER push to branches you weren't assigned to**
5. **Features MUST be implemented in feature branches (not dev/main)**

## Pre-Flight Checklist

Before ANY git operation, run:

```bash
pwd                    # Verify worktree path
git branch --show-current   # Verify branch name
sdp guard context check     # Validate session
```

## Required Pattern

```bash
# CORRECT
sdp guard context check && git commit -m "message"

# WRONG - no verification
git commit -m "message"

# WRONG - assumes CWD is correct
cd /path && git commit  # CWD resets after!
```

## Error Recovery

If context check fails:
1. DO NOT proceed with git command
2. Run: sdp guard context find $EXPECTED_FEATURE
3. Run: sdp guard context go $EXPECTED_FEATURE
4. Retry git command

## Forbidden Commands

- `git push --force` â€” NEVER
- `git checkout main` without explicit user request
- `git checkout dev` for feature work
- `git merge` across feature branches
- `git rebase` without user approval
- Direct commits to `main` or `dev` for features

## Feature Branch Rule

ALL feature implementation MUST happen in feature branches:
- Create: `git checkout -b feature/F065`
- Never commit to `dev` or `main` directly
- Guard will reject commits to protected branches
```

## Skill Updates

Add to each skill's git operations section:

```markdown
## Git Operations

**MANDATORY before any git command:**

```bash
# Step 1: Verify context
pwd
git branch --show-current
sdp guard context check

# Step 2: If check fails, recover
sdp guard context go $FEATURE_ID

# Step 3: Only then proceed
git add .
git commit -m "..."
```
```

## Agent Spec Updates

Add to orchestrator.md and builder.md:

```
You are working in worktree: /path/to/sdp-F065
Feature: F065
Expected branch: feature/F065

BEFORE any git operation:
1. Run: sdp guard context check
2. If fails: Run: sdp guard context go F065
3. Then proceed with git command

NEVER skip these steps. Your CWD may reset after tool calls.

CRITICAL: Features MUST be implemented in feature branches.
Never commit to dev or main for feature work.
```
