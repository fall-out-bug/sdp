---
ws_id: 00-051-03
feature_id: F051
title: "Drift Detection: Enhanced System"
status: backlog
priority: 0
depends_on: [00-051-01]
blocks: []
project_id: sdp
beads_id: sdp-6fx.11
---

## Goal

Extend existing drift detection to support all 3 drift types: Code↔Docs, Decisions↔Code, Docs↔Docs.

## Context

Part of F051 Long-term Memory System. Current drift detection (internal/drift) only handles Code↔Docs for workstreams. Extend to full drift detection.

**Related Beads:** sdp-6fx.11 (Drift detection system)

**Existing Code:** internal/drift/detector.go already implements basic workstream drift.

## Acceptance Criteria

- [ ] AC1: Code↔Docs drift with file:line references (enhance existing)
- [ ] AC2: Decision drift via ADR validation (check if ADR decisions match code)
- [ ] AC3: Docs↔Docs drift via cross-reference validation
- [ ] AC4: Drift report generated on demand with severity levels
- [ ] AC5: Integration with memory indexer for artifact lookup

## Scope Files

```yaml
scope_files:
  - sdp-plugin/internal/drift/detector.go         # MODIFY
  - sdp-plugin/internal/drift/detector_test.go    # MODIFY
  - sdp-plugin/internal/drift/adr_validator.go    # NEW
  - sdp-plugin/internal/drift/crossref.go         # NEW
  - sdp-plugin/internal/drift/report.go           # MODIFY
  - sdp-plugin/cmd/sdp/drift.go                   # MODIFY
```

## Implementation Notes

### Drift Types

1. **Code↔Docs** (existing, enhance):
   - Check workstream scope_files vs actual files
   - Add line-level drift detection

2. **Decisions↔Code** (new):
   - Parse docs/decisions/*.md for ADRs
   - Check if code follows decision status
   - Example: "Use SQLite" → check if SQLite is used

3. **Docs↔Docs** (new):
   - Cross-reference links between docs
   - Check for contradictions
   - Flag stale references

### Report Enhancement

```go
type DriftReport struct {
    WorkstreamID string
    Timestamp    time.Time
    DriftTypes   []DriftTypeReport
    Verdict      string
}

type DriftTypeReport struct {
    Type        string   // "code_docs", "decision_code", "docs_docs"
    Severity    string   // "error", "warning", "info"
    Issues      []DriftIssue
    Suggestions []string
}
```

## Definition of Done

- [ ] All AC met
- [ ] Tests pass with ≥80% coverage
- [ ] CLI command: `sdp drift detect --type=all`
- [ ] Recall >90% on test drift scenarios
