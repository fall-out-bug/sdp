---
ws_id: 00-065-02
feature_id: F065
title: "Git Operation Wrapper"
status: backlog
priority: 1
depends_on: [00-065-01]
blocks: []
project_id: sdp
beads_id: sdp-lj9m
---

## Goal

Create `sdp git` wrapper that validates session before executing any git command.

## Context

Agents run git commands directly without verification. A wrapper ensures session is validated before every operation.

**Design Reference:** docs/plans/2026-02-12-agent-git-safety-protocol.md (Section 2)

## Acceptance Criteria

- [ ] AC1: Implement `sdp git <command>` wrapper
- [ ] AC2: Validate session before command execution
- [ ] AC3: Validate CWD matches session.worktree_path
- [ ] AC4: Validate current branch matches session.expected_branch
- [ ] AC5: Post-check for write commands (branch didn't change)
- [ ] AC6: Remote tracking verification for push commands
- [ ] AC7: Clear error messages with remediation guidance
- [ ] AC8: Unit tests with â‰¥80% coverage

## Scope Files

```yaml
scope_files:
  - sdp-plugin/cmd/sdp/git_wrapper.go      # NEW: git wrapper CLI
  - sdp-plugin/internal/git/
    - wrapper.go                            # NEW: wrapper logic
    - validator.go                          # NEW: git validation
```

## Command Behavior

### Safe Commands (status, log, diff, show)
- Session check only (no post-check)

### Write Commands (add, commit, reset)
- Full validation + post-check branch unchanged

### Remote Commands (push, fetch, pull)
- Remote tracking verification

### Branch Commands (checkout, branch, merge)
- Session update required (or error)

## Validation Flow

```
1. Load .sdp/session.json
2. Verify worktree_path matches pwd
3. Verify expected_branch matches current branch
4. Verify expected_remote matches tracking
5. Verify hash is valid
6. Execute: git <command>
7. Verify still on expected_branch (for write commands)
```

## Error Messages

```
ERROR: Wrong worktree: expected /path/to/sdp-F065, in /path/to/sdp
FIX: sdp guard context go F065

ERROR: Wrong branch: expected feature/F065, on dev
FIX: git checkout feature/F065

ERROR: Session file corrupted or tampered
FIX: sdp session repair --force
```
