---
ws_id: 00-051-07
feature_id: F051
title: "Checkpoint: Snapshots and Rollback"
status: backlog
priority: 1
depends_on: [00-051-04]
blocks: []
project_id: sdp
beads_id: sdp-6fx.8
---

## Goal

Enhance checkpoint system with snapshots and rollback capability for long-running features.

## Context

Part of F051 Long-term Memory System. Extends existing checkpoint mechanism in orchestrator to support state snapshots and recovery.

**Related Beads:** sdp-6fx.8 (Checkpoint with snapshots and rollback)

**Existing Code:** internal/orchestrator/checkpoint.go has basic checkpoint support.

## Acceptance Criteria

- [ ] AC1: Snapshot agent state at configurable intervals
- [ ] AC2: Snapshot includes: completed tasks, pending tasks, in-progress work
- [ ] AC3: Rollback to any previous snapshot
- [ ] AC4: Snapshot diff visualization
- [ ] AC5: Automatic snapshot before risky operations

## Scope Files

```yaml
scope_files:
  - sdp-plugin/internal/orchestrator/checkpoint.go      # MODIFY
  - sdp-plugin/internal/orchestrator/checkpoint_test.go # MODIFY
  - sdp-plugin/internal/orchestrator/snapshot.go        # NEW
  - sdp-plugin/internal/orchestrator/snapshot_test.go   # NEW
  - sdp-plugin/cmd/sdp/checkpoint.go                    # NEW
```

## Implementation Notes

### Snapshot Structure

```go
type Snapshot struct {
    ID           string           `json:"id"`
    FeatureID    string           `json:"feature_id"`
    Timestamp    time.Time        `json:"timestamp"`
    CompletedWS  []string         `json:"completed_ws"`
    PendingWS    []string         `json:"pending_ws"`
    InProgress   *WorkInProgress  `json:"in_progress"`
    Metrics      SnapshotMetrics  `json:"metrics"`
    ParentID     string           `json:"parent_id,omitempty"`
}

type WorkInProgress struct {
    WSID       string `json:"ws_id"`
    Stage      string `json:"stage"`
    StartedAt  time.Time `json:"started_at"`
    PartialArtifacts []string `json:"partial_artifacts"`
}
```

### Snapshot Triggers

- Manual: `sdp checkpoint create`
- Automatic: every N completed workstreams
- Pre-risky: before merge, before destructive ops
- On-error: when agent fails

### Rollback Logic

```go
func (o *Orchestrator) Rollback(snapshotID string) error {
    snap, err := o.loadSnapshot(snapshotID)
    if err != nil {
        return err
    }

    // Restore state
    o.completed = snap.CompletedWS
    o.pending = snap.PendingWS
    o.inProgress = snap.InProgress

    // Emit rollback event
    o.emitEvent("rollback", snap)

    return nil
}
```

## Definition of Done

- [ ] All AC met
- [ ] Tests pass with â‰¥80% coverage
- [ ] CLI commands: `sdp checkpoint list/create/rollback`
- [ ] Snapshots stored in .sdp/snapshots/
