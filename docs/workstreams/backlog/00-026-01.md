---
ws_id: 00-026-01
feature_id: F026
status: done
priority: P1
size: S
depends_on: []
---

# 00-026-01: Prompt Provenance in Evidence Schema

Feature: F026 (sdp_dev-5pl6)

## Goal

Add `prompt_hash` and `context_sources` fields to the `provenance` section of the evidence envelope. Turns "what did the agent actually see?" into a verifiable evidence record. Instead of building a complex prompt generation framework, we *prove* what the agent received.

Depends on F001 (Evidence Schema) which is **done** — this extends the published schema.

## Scope Files

- `docs/workstreams/backlog/00-026-01.md` — workstream spec (scope update)
- `specs/strict-evidence-template.json` — add `prompt_hash`, `context_sources` to provenance
- `schema/evidence-envelope.schema.json` — update JSON Schema
- `internal/evidence/strict.go` — add fields to Go struct, validation
- `internal/evidence/strict_test.go` — test new fields
- `internal/evidence/inspect.go` — display prompt provenance in inspect output
- `internal/evidence/inspect_test.go` — test inspect provenance display
- `internal/orchestrate/invoke_opencode.go` — compute prompt_hash before LLM invoke
- `internal/orchestrate/invoke_opencode_test.go` — test provenance helpers
- `internal/orchestrate/loop.go` — pass featureID to RunBuildPhase

## Acceptance Criteria

- [ ] `provenance.prompt_hash`: SHA-256 of the fully rendered prompt sent to the LLM
- [ ] `provenance.context_sources`: array of `{type, path, hash}` — every input that entered the context
- [ ] Context source types: `workstream_spec`, `checkpoint`, `scope_file`, `agents_md`, `skill`, `context_packet`
- [ ] `sdp-evidence validate` checks `prompt_hash` is a valid SHA-256 hex string
- [ ] `sdp-evidence validate` checks `context_sources` is a non-empty array with valid entries
- [ ] `sdp-evidence inspect` displays prompt provenance in human-readable format
- [ ] Hash computed AFTER all prompt assembly, BEFORE LLM invocation (captures exactly what was sent)
- [ ] Backward compatible: envelopes without these fields still validate (fields optional for migration)
- [ ] Test: envelope with prompt provenance validates, inspect output includes provenance

## Out of Scope

- Prompt replay / reproduction (future — this records, doesn't replay)
- Prompt diffing between runs
- Prompt optimization based on recorded data

## Implementation Notes

Computing `prompt_hash`:
```go
rendered := prompt.Render(ws, checkpoint, contextPacket)
hash := sha256.Sum256([]byte(rendered))
envelope.Provenance.PromptHash = hex.EncodeToString(hash[:])
```

Computing `context_sources`:
```go
sources := []ContextSource{
    {Type: "workstream_spec", Path: wsPath, Hash: fileHash(wsPath)},
    {Type: "checkpoint", Path: cpPath, Hash: fileHash(cpPath)},
    // ... for each input
}
envelope.Provenance.ContextSources = sources
```

This pairs naturally with F022 (Context Pre-Hydration): the context packet becomes one of the recorded sources.

Research: [Prompt Provenance Design](../../plans/2026-02-23-prompt-provenance-design.md)

---

### Review Results

**Reviewed by:** Cursor (reviewer agent)
**Date:** 2026-02-23

| # | Check | Status |
|---|-------|--------|
| 0 | Goal Achieved | PASS — All AC implemented |
| 1 | Tests pass | PASS — `go test ./internal/evidence/... ./internal/orchestrate/...` |
| 2 | Coverage | N/A — project-wide 40%; F026 changes have tests |
| 3 | Regression | PASS — All tests pass |
| 4 | Linters | PASS — `go vet ./...` clean |
| 5 | Type hints | PASS — Go, fully typed |
| 6 | No TODO/FIXME | PASS — No new TODOs in F026 scope |
| 7 | File size | PASS — All touched files < 200 LOC |
| 8 | Clean Architecture | PASS — Evidence/orchestrate boundaries respected |
| 9 | Docstrings | PASS — Exported functions documented |
| 10 | Type annotations | PASS — Go |
| 11 | Execution Report | PASS — PR #57 merged, CI green |

**AC verification:**
- `provenance.prompt_hash`: SHA-256 of rendered prompt — `ComputePromptHash` in invoke_opencode.go
- `provenance.context_sources`: array of `{type, path, hash}` — `BuildContextSources`, `ContextSource` struct
- Context source types: workstream_spec, checkpoint, scope_file, agents_md, skill, context_packet — schema enum
- `sdp-evidence validate` checks prompt_hash — strict.go hasProvenanceContract
- `sdp-evidence validate` checks context_sources — strict.go validates entries when present
- `sdp-evidence inspect` displays provenance — inspect.go formatSummary
- Hash computed AFTER all prompt assembly, BEFORE LLM — RunBuildPhase computes before InvokeOpenCode
- Backward compatible — optional validation, schema pattern allows empty
- Test: envelope with prompt provenance validates — TestValidateStrictFile_promptProvenance, TestInspectPromptProvenance

**Verdict:** APPROVED
