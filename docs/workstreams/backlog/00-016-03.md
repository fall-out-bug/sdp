---
ws_id: 00-016-03
feature_id: F016
status: done
priority: P1
size: M
depends_on: ["00-016-01"]
---

# 00-016-03: Oneshot Outer Loop — Claude Code Integration

Feature: F016 (sdp_dev-yxql)

## Goal

Wire the outer loop state machine into Claude Code's agent model. Task tool subagents handle @build/@review; outer loop CLI handles flow control.

## Scope Files

- `.claude/skills/oneshot/SKILL.md` — slim version for Claude Code
- `sdp/prompts/skills/oneshot/SKILL.md` — canonical source

## Acceptance Criteria

- [x] `@oneshot F004` in Claude Code uses `sdp orchestrate` as outer loop
- [x] Build phases: Task tool spawns subagent for each @build
- [x] Review phase: Task tool spawns @review subagent
- [x] PR + CI phases: CLI only, no LLM
- [x] Stop hook (F015) catches any premature exit attempts
- [x] No "Next steps" or handoff lists in output
- [x] Test: complete F001-level feature in Claude Code without premature exit (3/3 runs)

## Out of Scope

- Cursor-specific integration (00-016-02)
- Eval suite (F017)

## Implementation Notes

### Claude Code Workflow

```
User: @oneshot F004
Agent: Reads checkpoint → runs `sdp orchestrate F004 --next-action`
CLI outputs: {"action": "build", "ws_id": "00-004-01", "context": "..."}
Agent: Spawns Task(subagent_type="builder", prompt="@build 00-004-01 ...")
Agent: Task returns → runs `sdp orchestrate F004 --advance --result pass`
CLI outputs: {"action": "build", "ws_id": "00-004-02", ...}
... repeats until:
CLI outputs: {"action": "ci-loop", "pr": 42}
Agent: runs `sdp ci-loop --pr 42 --feature F004`
CLI exits 0
Agent: runs `sdp orchestrate F004 --advance`
CLI outputs: {"action": "done"}
Agent: outputs "CI GREEN - @oneshot complete"
```

### Stop Hook as Safety Net

If agent tries to exit between phases, Stop hook reads checkpoint and blocks. Agent is forced back into the loop. Defense in depth.

### Key Difference from Cursor

In Claude Code, @build and @review can run as isolated subagents (Task tool). This gives better context management — each subagent gets a fresh context window for its workstream, avoiding the context degradation problem.
