---
ws_id: 00-050-10
parent: sdp-79u
feature: F050
status: backlog
size: SMALL
project_id: 00
---

## WS-00-050-10: Checkpoint System (Simplified)

### üéØ Goal

Implement simplified checkpoint system for @oneshot resume. Enable state persistence for multi-agent orchestration with JSON-based storage (no SQLite).

**What must WORK after completing this WS:**
- Save checkpoint to `.sdp/checkpoints/<feature>.json`
- Load checkpoint by feature ID
- Track completed workstreams, current workstream, status
- `sdp oneshot --resume <feature>` continues from checkpoint
- Delete checkpoint after successful completion

**Acceptance Criteria:**
- [ ] AC1: Checkpoint saved to `.sdp/checkpoints/<feature>.json`
- [ ] AC2: Checkpoint loaded by feature ID
- [ ] AC3: Completed workstreams tracked
- [ ] AC4: Current workstream tracked
- [ ] AC5: Resume capability works
- [ ] AC6: Checkpoint deleted after completion
- [ ] Coverage ‚â• 80%

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### üìã Contracts

**Technical Constraints:**
- Must use JSON storage (not SQLite)
- Must store in `.sdp/checkpoints/` directory
- Must track: Feature, AgentID, Status, CompletedWS[], CurrentWS
- Must support resume from interruption

---

### üîå Interfaces

```go
package checkpoint

type Status string

const (
    StatusRunning   Status = "running"
    StatusPaused    Status = "paused"
    StatusCompleted Status = "completed"
    StatusFailed    Status = "failed"
)

type Checkpoint struct {
    FeatureID      string
    AgentID        string
    Status         Status
    CompletedWS    []string
    CurrentWS      string
    StartTime      time.Time
    LastUpdate     time.Time
}

type Repository struct {
    checkpointDir string
}

func NewRepository(baseDir string) (*Repository, error)
func (r *Repository) Save(cp *Checkpoint) error
func (r *Repository) Load(featureID string) (*Checkpoint, error)
func (r *Repository) Delete(featureID string) error
func (r *Repository) List() ([]string, error)
func (r *Repository) Exists(featureID string) bool
```

---

### üìÅ Scope Files

**Implementation:**
- `internal/checkpoint/repository.go`
- `internal/checkpoint/checkpoint.go`
- `cmd/sdp/commands/oneshot.go`

**Tests:**
- `internal/checkpoint/repository_test.go`

---

### ‚úÖ Testing

**Unit Tests:**
```bash
# Save and load
TestSaveCheckpoint()
TestLoadCheckpoint()
TestLoadNonExistent()

# Update operations
TestUpdateCompletedWS()
TestUpdateCurrentWS()
TestUpdateStatus()

# Delete operations
TestDeleteCheckpoint()
TestListCheckpoints()

# Resume scenarios
TestResumeFromRunning()
TestResumeFromPaused()
```

**Integration Tests:**
```bash
# Create checkpoint
sdp oneshot F01
# Checkpoint created: .sdp/checkpoints/F01.json

# Interrupt and resume
# (Ctrl+C during execution)
sdp oneshot --resume F01
# Resumes from last checkpoint
```

---

### üîç Verification

**Pre-build:**
- [ ] Review JSON schema
- [ ] Verify checkpoint directory creation
- [ ] Check file permissions
- [ ] Test concurrent access scenarios

**Post-build:**
```bash
# Run tests
go test ./internal/checkpoint/... -v -cover

# Manual integration test
sdp oneshot F01
ls -la .sdp/checkpoints/F01.json

# Interrupt execution
# (Ctrl+C)
sdp oneshot --resume F01

# Verify checkpoint deleted after completion
ls .sdp/checkpoints/  # Should be empty
```

---

### üìù Notes

**Dependencies:** 00-050-04

**Context:**
Simplified checkpoint system (200 LOC vs 800 LOC Python). Recommendation from deep-thinking: "Use Beads gates for coordination if possible, fallback to JSON for simplicity."

**Key Decisions:**
- JSON storage (not SQLite) - simpler, sufficient
- 200 LOC vs 800 LOC Python - 75% reduction
- Simple schema: Feature, AgentID, Status, CompletedWS[], CurrentWS
- Delete after completion (no archival needed)

**Risks:**
- JSON file corruption
- Concurrent access conflicts
- Checkpoint directory not created
- Resume from stale checkpoint

**Mitigations:**
- Atomic write (temp file + rename)
- File locking (flock) for concurrent access
- Auto-create directory on Save
- Timestamp validation (reject stale checkpoints)

**Checkpoint Schema:**
```json
{
  "feature_id": "F01",
  "agent_id": "abc123xyz",
  "status": "running",
  "completed_ws": ["00-001-01", "00-001-04"],
  "current_ws": "00-001-02",
  "start_time": "2026-02-05T10:00:00Z",
  "last_update": "2026-02-05T10:30:00Z"
}
```

**File Operations:**
- Save: Atomic write (temp file + rename)
- Load: Parse JSON, validate schema
- Delete: Remove file (ignore if not exists)
- Exists: Check file existence

**Error Handling:**
- Save fails: Return error (caller should retry)
- Load fails: Return "not found" error
- Delete fails: Ignore (already deleted)
- Corrupted JSON: Return error (checkpoint invalid)

**Integration with @oneshot:**
```bash
# Start oneshot
sdp oneshot F01
# Creates checkpoint: .sdp/checkpoints/F01.json

# Interrupt (Ctrl+C)
# Checkpoint saved with Status="paused"

# Resume
sdp oneshot --resume F01
# Loads checkpoint, continues from CurrentWS
```

**Directory Structure:**
```
.sdp/
‚îî‚îÄ‚îÄ checkpoints/
    ‚îú‚îÄ‚îÄ F01.json
    ‚îú‚îÄ‚îÄ F02.json
    ‚îî‚îÄ‚îÄ F03.json
```
