---
ws_id: 00-015-02
feature_id: F015
status: done
priority: P0
size: S
depends_on: ["00-015-01"]
---

# 00-015-02: Stop Hook — Claude Code Implementation

Feature: F015 (sdp_dev-3l1m)

## Goal

Port the stop hook gate to Claude Code's hook system. Same logic, different configuration format.

## Scope Files

- `scripts/oneshot-stop-gate.sh` — shared script (from 00-015-01)
- `.claude/settings.json` — Claude Code hook configuration

## Acceptance Criteria

- [x] Hook configured in `.claude/settings.json` under `hooks.Stop`
- [x] Same checkpoint-based gate logic as Cursor version
- [x] Works with Claude Code's `stop_hook_active` flag
- [x] Exit code 2 blocks with continuation message
- [x] Test: Claude Code agent stopped before CI → blocked; after CI green → allowed

## Out of Scope

- Different logic between Cursor and Claude Code (same script, different config)

## Implementation Notes

Claude Code hook config format:

```json
{
  "hooks": {
    "Stop": [{
      "type": "command",
      "command": "bash scripts/oneshot-stop-gate.sh"
    }]
  }
}
```

The same `scripts/oneshot-stop-gate.sh` works for both platforms. Only the configuration file differs.

## Usage in Claude Code

Claude Code runs `@oneshot F004` → builds → creates PR → tries to end turn → hook blocks → agent reads block message → runs `sdp ci-loop` → CI green → checkpoint updated → next end turn → hook allows → session ends cleanly.
