---
ws_id: 00-050-02
parent: sdp-79u
feature: F050
status: backlog
size: MEDIUM
project_id: 00
---

## WS-00-050-02: TDD Runner Implementation

### üéØ Goal

Implement Red-Green-Refactor cycle with pytest integration. Enable automated test execution with phase tracking and error reporting.

**What must WORK after completing this WS:**
- Red phase runs pytest, expects failure
- Green phase runs pytest, expects success
- Refactor phase runs pytest, ensures tests still pass
- Each phase captures stdout/stderr for error messages
- Each phase reports duration (for telemetry)
- RunAllPhases executes Red‚ÜíGreen‚ÜíRefactor sequentially
- Context support for cancellation (ctx.Cancel)

**Acceptance Criteria:**
- [ ] AC1: Red phase runs pytest, expects failure (returncode != 0)
- [ ] AC2: Green phase runs pytest, expects success (returncode == 0)
- [ ] AC3: Refactor phase runs pytest, ensures tests still pass
- [ ] AC4: RunAllPhases executes all 3 phases sequentially
- [ ] AC5: Each phase reports duration (time.Since)
- [ ] AC6: Context cancellation stops execution immediately
- [ ] Coverage ‚â• 80%

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### üìã Contracts

**Technical Constraints:**
- Must use os/exec for pytest execution
- Must capture stdout/stderr separately
- Must support context.Context for cancellation
- Must return structured errors (phase + cause)

---

### üîå Interfaces

```go
package tdd

type Phase int

const (
    Red Phase = iota
    Green
    Refactor
)

type Runner struct {
    pytestPath string
}

func (r *Runner) RunPhase(ctx context.Context, phase Phase, wsPath string) (*PhaseResult, error)
func (r *Runner) RunAllPhases(ctx context.Context, wsPath string) ([]*PhaseResult, error)

type PhaseResult struct {
    Phase    Phase
    Success  bool
    Duration time.Duration
    Stdout   string
    Stderr   string
    Error    error
}
```

---

### üìÅ Scope Files

**Implementation:**
- `internal/tdd/runner.go`
- `internal/tdd/phase.go`
- `cmd/sdp/commands/build.go`

**Tests:**
- `internal/tdd/runner_test.go`

---

### ‚úÖ Testing

**Unit Tests:**
```bash
# Red phase execution
TestRedPhaseFails()

# Green phase execution
TestGreenPhaseSucceeds()

# Refactor phase execution
TestRefactorPhasePasses()

# Context cancellation
TestContextCancellation()
```

**Integration Tests:**
```bash
# Full TDD cycle
go test ./internal/tdd/... -run TestIntegrationTDDCycle
```

---

### üîç Verification

**Pre-build:**
- [ ] Review pytest command construction
- [ ] Verify context cancellation logic
- [ ] Check error propagation

**Post-build:**
```bash
# Run tests
go test ./internal/tdd/... -v -cover

# Manual integration test
cd /tmp/test-project
../../sdp build 00-050-02

# Expected: Executes Red ‚Üí Green ‚Üí Refactor
```

---

### üìù Notes

**Dependencies:** 00-050-01

**Context:**
Simplified from Python (800 LOC ‚Üí 400 LOC). TDD runner is core to SDP workflow. Context cancellation enables @oneshot to stop mid-execution.

**Key Decisions:**
- os/exec for subprocess management (standard library)
- Separate stdout/stderr capture (better error messages)
- Context cancellation (Go best practice)
- Structured PhaseResult (enables telemetry)

**Risks:**
- pytest not installed in PATH
- pytest returns unexpected exit codes
- Context doesn't propagate to subprocess

**Mitigations:**
- Detect pytest in PATH before execution
- Validate pytest exit codes (0 = pass, 1 = fail, 2 = error)
- Use cmd.Process.Kill() for forceful termination
