---
ws_id: 00-016-04
feature_id: F016
status: done
priority: P2
size: M
depends_on: ["00-016-01"]
---

# 00-016-04: Oneshot Outer Loop — opencode Integration

Feature: F016 (sdp_dev-5xsz)

## Goal

Integrate opencode into the outer loop architecture so that `sdp orchestrate` can invoke opencode agents as the LLM inner loop, and opencode commands route through `sdp orchestrate` as the outer loop entry point.

## Scope Files

- `.opencode/opencode.json` — agent routing config
- `sdp/prompts/commands/oneshot.md` — ensure outer loop invocation documented
- `internal/orchestrate/invoke_opencode.go` — opencode invocation adapter (new)
- `docs/plans/2026-02-23-agent-loop-reliability.md` — update with opencode section

## Acceptance Criteria

- [x] `sdp orchestrate F{XX}` can invoke opencode agents via CLI subprocess (`opencode run --agent orchestrator`)
- [x] `opencode.json` has a documented pattern for routing feature commands to `sdp orchestrate` as outer loop
- [x] opencode `oneshot` command references the outer loop entrypoint (`sdp orchestrate`) rather than inline workflow
- [x] opencode lacks native Stop hooks — this WS documents the approved alternative: outer loop CLI replaces Stop hook for opencode
- [x] Test: `sdp orchestrate F004 --runtime opencode` drives full flow using opencode as inner loop

## Out of Scope

- opencode runtime deployment (K8s, Docker)
- opencode binary packaging
- Cursor or Claude Code adapters (covered by 00-016-02 and 00-016-03)

## Implementation Notes

opencode doesn't support Cursor/Claude Code-style Stop hooks. The outer loop enforcement for opencode is achieved by:

1. `sdp orchestrate` as the outer loop — it calls `opencode run` as a subprocess per phase
2. opencode agents complete their phase and exit (no handoff lists)
3. `sdp orchestrate` reads the exit code and checkpoint to decide next phase

The `opencode.json` `agent:` frontmatter field is used to route commands to the appropriate agent. For the outer loop, `agent: orchestrator` should map to `sdp orchestrate` invocation.

```json
{
  "mcpServers": {},
  "defaultAgent": "orchestrator"
}
```

The `oneshot` command should document that its outer loop is `sdp orchestrate`, not the inline Bash loop.
