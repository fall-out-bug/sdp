---
ws_id: 00-016-01
feature_id: F016
status: done
priority: P1
size: L
depends_on: ["00-015-02"]
---

# 00-016-01: Oneshot Outer Loop — State Machine CLI

Feature: F016 (sdp_dev-kvsi)

## Goal

Rewrite `sdp orchestrate` from a k8s dispatcher into a real outer loop state machine. CLI drives the workflow phases; LLM invoked only for creative decisions.

## Scope Files

- `cmd/sdp-orchestrate/main.go` — rewrite or new entry point
- `internal/orchestrate/state_machine.go` — phase transitions: init → build → review → pr → ci → done
- `internal/orchestrate/checkpoint.go` — checkpoint read/write/advance
- `.sdp/checkpoints/` — checkpoint files (existing schema)

## Acceptance Criteria

- [x] `sdp orchestrate F004` drives the full workflow as a state machine
- [x] Phases: `init → build → review → pr → ci → done`
- [x] Each phase transition updates checkpoint atomically
- [x] `build` phase: invokes Cursor/Claude agent with "@build {ws-id}" for each WS
- [x] `review` phase: invokes agent with "@review F004"
- [x] `pr` phase: deterministic — `git push`, `gh pr create`
- [x] `ci` phase: delegates to `sdp ci-loop` (F014)
- [x] Resume from any phase: `sdp orchestrate F004 --resume`
- [x] Test: full flow init→done; resume from review; resume from ci

## Out of Scope

- LLM invocation mechanism details (00-016-02 covers Cursor, 00-016-03 covers Claude Code)
- Eval suite (F017)

## Implementation Notes

The state machine is a `switch` on checkpoint phase:

```go
switch checkpoint.Phase {
case "init":    loadFeatureContext(); advanceTo("build")
case "build":   for ws := range workstreams { invokeLLM("@build " + ws); advanceTo("review") }
case "review":  invokeLLM("@review " + feature); advanceTo("pr")
case "pr":      gitPush(); ghPRCreate(); advanceTo("ci")
case "ci":      exec("sdp ci-loop --pr ..."); advanceTo("done")
case "done":    exit(0)
}
```

The LLM decides WHAT to build/review. The CLI decides WHEN to advance phases.
