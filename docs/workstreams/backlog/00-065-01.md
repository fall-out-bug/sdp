---
ws_id: 00-065-01
feature_id: F065
title: "Session State Management"
status: backlog
priority: 0
depends_on: []
blocks: [00-065-02, 00-065-03, 00-065-04, 00-065-06]
project_id: sdp
beads_id: sdp-93lc
---

## Goal

Implement per-worktree session state tracking to establish identity context for all git operations.

## Context

Agents lose context when CWD resets after Bash tool calls. A session file provides persistent identity that can be validated before any git operation.

**Design Reference:** docs/plans/2026-02-12-agent-git-safety-protocol.md (Section 1)

## Acceptance Criteria

- [ ] AC1: Create `.sdp/session.json` format with required fields
- [ ] AC2: Implement `sdp session init` command to create session file
- [ ] AC3: Implement `sdp session sync` to update session from git state
- [ ] AC4: Implement `sdp session repair` to rebuild corrupted sessions
- [ ] AC5: Add hash verification for tamper detection
- [ ] AC6: Update `sdp worktree create` to initialize session automatically
- [ ] AC7: Unit tests with â‰¥80% coverage

## Scope Files

```yaml
scope_files:
  - sdp-plugin/cmd/sdp/session.go          # NEW: session CLI commands
  - sdp-plugin/internal/session/
    - session.go                            # NEW: session struct and CRUD
    - validator.go                          # NEW: hash validation
  - sdp-plugin/internal/worktree/
    - creator.go                            # MODIFY: add session init
```

## Session File Format

```json
{
  "version": "1.0",
  "worktree_path": "/Users/user/projects/sdp-F065",
  "feature_id": "F065",
  "expected_branch": "feature/F065",
  "expected_remote": "origin/feature/F065",
  "created_at": "2026-02-12T10:00:00Z",
  "created_by": "sdp worktree create",
  "hash": "sha256:abc123..."
}
```

## Commands

```bash
# Initialize session in current worktree
sdp session init --feature=F065

# Sync session with actual git state
sdp session sync

# Repair corrupted session
sdp session repair --force
```

## Technical Notes

- Hash is SHA256 of file content (excluding hash field)
- Session file must be in `.sdp/` directory (not `.git/`)
- `sdp worktree create` should call session init automatically
- Session sync should detect and report mismatches
