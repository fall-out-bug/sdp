---
ws_id: 00-007-01
feature_id: F007
status: backlog
priority: P1
size: L
depends_on: ["00-006-02"]
---

# 00-007-01: EvidenceAssembler — Subscribe, Collect, Validate

Feature: F007 (sdp_dev-qet)

## Goal

Component that subscribes to JetStream evidence stream, collects fragments per issue, validates hash chain via `BusService.Ingest()`, and holds assembled envelopes in memory.

## Scope Files

- `internal/evidence/assembler.go` — new
- `internal/evidence/assembler_test.go` — new
- `internal/artifact/bus_service.go` — existing, used for chain validation

## Acceptance Criteria

- [ ] `evidence.Assembler` subscribes to `sdp.evidence.<issueID>.>` (or `sdp.evidence.>` for all issues)
- [ ] Collects fragments per issueID, tracks which of 9 sections received
- [ ] Each fragment fed into `BusService.Ingest()` for hash chain validation
- [ ] `assembler.GetEnvelope(issueID)` returns assembled envelope when all sections present
- [ ] `assembler.IsComplete(issueID)` returns true when all 9 sections received
- [ ] Handles out-of-order fragment arrival (buffer until complete)
- [ ] Handles JetStream replay on restart (idempotent ingestion)
- [ ] Test: publish 9 fragments in random order, verify complete envelope assembled

## Out of Scope

- Filesystem materialization (00-007-02)
- PR gate integration (00-007-02)

## Implementation Notes

- Use a `map[string]*pendingEnvelope` with mutex for concurrent fragment arrival
- JetStream consumer with `DeliverAll()` for replay on restart
- Consider a timeout: if envelope incomplete after 30 minutes, emit warning
