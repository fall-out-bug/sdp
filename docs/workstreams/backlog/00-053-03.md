# Workstream 00-053-03: Contract Validation Agent

**Feature:** F053 - Component Contract Validation
**Issue:** sdp-ie25.4
**Project ID:** 00
**Status:** Pending
**Priority:** P1

## Overview

Implement contract validation agent that cross-references component contracts to detect integration mismatches. This is the core validation engine that prevents "404 Not Found" integration failures.

## Problem Statement

The original issue: Frontend calls POST /api/v1/telemetry/submit, backend exposes POST /api/v1/telemetry/events → 404 Not Found.

**No automated way to detect BEFORE deployment:**
- Endpoint mismatches
- Schema inconsistencies
- HTTP method differences
- Missing authentication headers

## Solution

Contract validation agent that:
- Reads generated contracts from all components
- Cross-references frontend vs backend
- Cross-references SDK vs backend
- Reports mismatches with file locations
- Suggests fixes

## Acceptance Criteria

1. **Contract validation agent** implemented in `src/sdp/agents/contract_validator.go`
2. Reads contracts from `.contracts/generated/{component}.yaml`
3. Validates frontend-backend alignment:
   - Endpoint paths match
   - HTTP methods match
   - Request schemas compatible
   - Response schemas compatible
4. Validates SDK-backend alignment:
   - SDK method names map to endpoints
   - Parameters match request schemas
   - Return types match response schemas
5. Reports mismatches with:
   - Component names (frontend, backend, SDK)
   - File locations (where mismatch occurred)
   - Severity (error, warning, info)
   - Suggested fix
6. Outputs report to `.contracts/validation-report.md`

## Scope

### In Scope
- Frontend-backend validation
- SDK-backend validation
- Endpoint matching
- Schema compatibility checking
- Mismatch reporting with file locations

### Out of Scope
- Contract generation (WS 00-053-02)
- Code extraction (WS 00-053-01)
- @review integration (WS 00-053-07)

## Implementation Approach

### Phase 1: Contract Comparison
1. Create `src/sdp/agents/contract_validator.go`
2. Implement `CompareContracts()` method
3. Load multiple contracts (frontend, backend, SDK)
4. Extract endpoints/methods from each

### Phase 2: Endpoint Matching
1. Implement `ValidateEndpoints()` method
2. Compare frontend API calls vs backend routes
3. Check:
   - Path match (exact or parameterized)
   - HTTP method match
   - Query parameters match
4. Report mismatches

### Phase 3: Schema Validation
1. Implement `ValidateSchemas()` method
2. Compare request schemas:
   - Required fields present
   - Data types compatible
   - Validation rules match
3. Compare response schemas:
   - Return types compatible
   - Field names match
4. Report incompatibilities

### Phase 4: Reporting
1. Implement `GenerateReport()` method
2. Format as Markdown table
3. Include:
   - Component names
   - File locations
   - Severity (error/warning/info)
   - Suggested fix
4. Write to `.contracts/validation-report.md`

## Dependencies

**UPSTREAM:**
- WS 00-053-02 (Contract generation provides specs)

**DOWNSTREAM:**
- WS 00-053-04 (@design uses validation logic)
- WS 00-053-07 (@review uses validation report)

## Testing

### Unit Tests
- `TestCompareContracts_MatchingEndpoints`
- `TestCompareContracts_EndpointMismatch`
- `TestValidateSchemas_Compatible`
- `TestValidateSchemas_Incompatible`
- `TestGenerateReport_Format`

### Integration Tests
- `TestEndToEnd_ContractValidation`
- Use mismatched contracts
- Verify all errors detected
- Verify report includes file locations

## Quality Gates

- Files < 200 LOC
- Cyclomatic complexity < 10
- Test coverage ≥ 80%
- No bare exceptions
- Full type hints

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tests passing
- [ ] Coverage ≥ 80%
- [ ] Integration test detects seeded mismatches
- [ ] Report format validated

## Notes

**Validation Strategy:**
- Exact match: `/api/v1/telemetry/submit` == `/api/v1/telemetry/submit`
- Parameterized match: `/api/v1/telemetry/{id}` matches `/api/v1/telemetry/123`
- Method match: POST == POST
- Schema compatible: All required fields present, types compatible

**Severity Levels:**
- ERROR: Endpoint or method mismatch (will fail at runtime)
- WARNING: Schema incompatibility (may fail at runtime)
- INFO: Minor differences (cosmetic)

**Report Format:**
```markdown
# Contract Validation Report

## Summary
- Total endpoints: 10
- Matching: 8
- Mismatches: 2

## Errors

### Frontend vs Backend
| Component | Endpoint | Expected | Actual | Location | Fix |
|-----------|----------|----------|--------|----------|-----|
| Frontend | /api/telemetry | POST | GET | src/app/api.ts:42 | Change to GET |
| Backend | /api/events | GET | POST | src/api/routes.go:108 | Change to GET |

### SDK vs Backend
| Component | Method | Expected | Actual | Location | Fix |
|-----------|--------|----------|--------|----------|-----|
| SDK | submit() | POST /submit | POST /submit | src/sdk/client.py:25 | Add required field |

## Warnings
[Schema incompatibilities]
```

## Execution Report Template

```
**Started:** [Timestamp]
**Completed:** [Timestamp]
**Duration:** Xm

**Files Modified:**
- src/sdp/agents/contract_validator.go (NEW, X LOC)
- src/sdp/agents/contract_validator_test.go (NEW, Y LOC)

**Test Results:**
- Unit tests: X/Y passing
- Integration tests: A/B passing
- Coverage: Z%

**Validation Results:**
- Detected X endpoint mismatches
- Detected Y schema incompatibilities
- All seeded errors detected in integration test

**Challenges:**
- [Any issues encountered]
```
