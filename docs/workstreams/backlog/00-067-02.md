---
ws_id: 00-067-02
feature_id: F067
title: "Prompt Source-of-Truth and Drift Guard"
status: backlog
priority: 0
size: MEDIUM
depends_on: [00-067-01]
blocks: [00-067-03, 00-067-08, 00-067-13]
project_id: sdp
---

## Goal

Establish a single canonical source tree for all prompt/agent definitions and add CI enforcement to prevent drift.

## Context

Agent prompts exist in two locations:
- `prompts/agents/` — 25 files (canonical, referenced by `.claude/agents` symlink)
- `sdp-plugin/prompts/agents/` — 10 files (older subset, potentially diverged)

This duplication leads to non-deterministic agent behavior: which version runs depends on which tool reads which path.

## Acceptance Criteria

- [ ] AC1: Identify all duplicate prompt/agent definition locations
- [ ] AC2: Remove or replace duplicates with symlinks to `prompts/` canonical source
- [ ] AC3: Add CI check that validates no duplicate prompt trees exist
- [ ] AC4: Verify `.claude/skills` and `.claude/agents` symlinks resolve correctly
- [ ] AC5: Add drift detection script that compares prompt trees for divergence
- [ ] AC6: Document canonical prompt path policy in `CONTRIBUTING.md`
- [ ] AC7: All agent definitions in `prompts/agents/` have consistent frontmatter format

## Scope Files

```yaml
scope_files:
  - prompts/agents/*.md                    # canonical source
  - sdp-plugin/prompts/agents/*.md         # duplicates to remove/symlink
  - .claude/agents                         # verify symlink
  - .claude/skills                         # verify symlink
  - .github/workflows/go-ci.yml           # add drift check
  - CONTRIBUTING.md                        # update canonical path docs
  - hooks/pre-commit.sh                   # optional drift check
```

## Implementation Notes

### Drift Detection Script

```bash
#!/bin/bash
# Check for duplicate prompt trees
CANONICAL="prompts/"
DUPLICATES=$(find . -path ./prompts -prune -o -name "*.md" -path "*/prompts/*" -print)
if [ -n "$DUPLICATES" ]; then
  echo "ERROR: Duplicate prompt files found outside canonical path"
  echo "$DUPLICATES"
  exit 1
fi
```

### Cleanup Strategy

1. Compare `sdp-plugin/prompts/agents/` vs `prompts/agents/` for divergence
2. If identical: replace with symlinks
3. If diverged: merge differences into canonical, then replace
4. Add CI step to prevent reintroduction

## Definition of Done

- [ ] Single canonical prompt source tree enforced
- [ ] CI fails on duplicate/diverged prompt files
- [ ] No stale agent copies remain
- [ ] AC1-AC7 met
