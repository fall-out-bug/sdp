---
ws_id: 00-065-03
feature_id: F065
title: "CWD Recovery & Validation Commands"
status: backlog
priority: 0
depends_on: [00-065-01]
blocks: []
project_id: sdp
beads_id: sdp-hklb
---

## Goal

Implement `sdp guard context` command group for CWD recovery and context validation.

## Context

When CWD resets to main repo, agents need to recover worktree context. These commands provide recovery and validation.

**Design Reference:** docs/plans/2026-02-12-agent-git-safety-protocol.md (Section 3, 7)

## Acceptance Criteria

- [ ] AC1: Implement `sdp guard context check` - validate current context
- [ ] AC2: Implement `sdp guard context show` - display full context details
- [ ] AC3: Implement `sdp guard context find <feature>` - locate worktree for feature
- [ ] AC4: Implement `sdp guard context go <feature>` - change to feature worktree
- [ ] AC5: Implement `sdp guard context clean` - clean up stale sessions
- [ ] AC6: Implement `sdp guard context repair` - rebuild session from git state
- [ ] AC7: Hybrid recovery: session + git worktree list + workstream metadata
- [ ] AC8: Exit codes for programmatic use
- [ ] AC9: Unit tests with ≥80% coverage

## Scope Files

```yaml
scope_files:
  - sdp-plugin/cmd/sdp/guard_context.go   # NEW: guard context CLI
  - sdp-plugin/internal/context/
    - recovery.go                          # NEW: CWD recovery logic
    - finder.go                            # NEW: worktree finder
```

## Commands

### check
```bash
sdp guard context check
# Output:
#   ✅ Worktree: /path/to/sdp-F065
#   ✅ Branch: feature/F065
#   ✅ Tracking: origin/feature/F065
#   ✅ Session: valid
# Exit: 0 if all pass, non-zero otherwise
```

### show
```bash
sdp guard context show
# Output:
#   Worktree Path: /path/to/sdp-F065
#   Feature ID: F065
#   Current Branch: feature/F065
#   Expected Branch: feature/F065
#   Remote Tracking: origin/feature/F065
#   Session Valid: yes
```

### find
```bash
sdp guard context find F065
# Output: /path/to/sdp-F063
# Uses: session files, git worktree list, workstream metadata
```

### go
```bash
sdp guard context go F065
# Changes to worktree for F065
# Equivalent to: cd $(sdp guard context find F065)
```

### clean
```bash
sdp guard context clean
# Removes expired sessions, invalid session files
```

### repair
```bash
sdp guard context repair
# Rebuilds session.json from git state
```

## Exit Codes

| Code | Meaning | Action |
|------|---------|--------|
| 0 | All checks pass | Proceed |
| 1 | Context mismatch | Run recovery |
| 2 | No session file | Initialize session |
| 3 | Hash mismatch | Repair session |

## Recovery Strategy

1. **Primary:** Read `.sdp/session.json`
2. **Fallback:** Parse `git worktree list` output
3. **Last resort:** Scan workstream files for feature_id
