---
ws_id: 00-008-02
feature_id: F008
status: backlog
priority: P2
size: M
depends_on: ["00-008-01"]
---

# 00-008-02: Persistent Budget Tracking + Auto-Downgrade

Feature: F008 (sdp_dev-dlok)

## Goal

Replace in-memory `BudgetTracking` with persistent tracking in a ConfigMap. Enforce daily budget limits. Auto-downgrade to economy tier at 80% threshold.

## Scope Files

- `internal/policy/budget.go` — new: persistent budget tracker
- `internal/policy/budget_test.go` — new
- `internal/policy/config.go` — existing: auto-downgrade logic
- `deploy/k8s/control/budget-status.yaml` — new ConfigMap

## Acceptance Criteria

- [ ] Daily spend tracked in `budget-status` ConfigMap with `{date, total_usd, runs[]}`
- [ ] Reconciler checks budget before creating each Task
- [ ] At 80% of daily limit: auto-downgrade to economy model tier
- [ ] At 100% of daily limit: reject new AgentRuns with `status.phase = BudgetExceeded`
- [ ] Budget resets daily (new date key)
- [ ] Test: simulate 80% spend → verify economy model selected
- [ ] Test: simulate 100% spend → verify AgentRun rejected

## Out of Scope

- Per-project budgets
- Real cost calculation from OpenRouter API (use estimates)

## Implementation Notes

- Current `BudgetTracking` in `internal/policy/` uses `sync.RWMutex` — dies on restart
- ConfigMap approach: read-modify-write with ResourceVersion for optimistic concurrency
- Cost estimates: use hardcoded $/1K-token rates per model from model-policy ConfigMap
