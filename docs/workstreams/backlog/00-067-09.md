---
ws_id: 00-067-09
feature_id: F067
title: "LOC Violation Remediation (Split Oversized Files)"
status: backlog
priority: 0
size: LARGE
depends_on: [00-067-01]
blocks: [00-067-14]
project_id: sdp
---

## Goal

Split all non-test Go source files exceeding 200 LOC to bring the project's own code into compliance with its declared quality gate.

## Context

SDP enforces a 200 LOC per file rule via `.sdp/guard-rules.yml`, quality-gate.toml, and the `@build` skill. However, 20+ source files violate this rule — the worst offenders exceed 500 LOC:

| File | LOC | Over by |
|------|-----|---------|
| `cmd/sdp/contract.go` | 572 | 372 |
| `agents/synthesis_agent.go` | 560 | 360 |
| `agents/code_analyzer.go` | 543 | 343 |
| `agents/contract_validator.go` | 485 | 285 |
| `doctor/doctor.go` | 468 | 268 |
| `cmd/sdp/decisions.go` | 415 | 215 |
| `orchestrator/feature_coordinator.go` | 403 | 203 |
| `ui/dashboard/app.go` | 394 | 194 |
| `cmd/sdp/metrics.go` | 386 | 186 |
| `telemetry/analyzer.go` | 377 | 177 |
| ... and 10+ more | | |

This is the **#1 credibility issue** — the project's own quality gates fail against its own code.

## Acceptance Criteria

- [ ] AC1: Identify all non-test `.go` files exceeding 200 LOC (baseline from WS-01)
- [ ] AC2: Split top 10 worst offenders (files >300 LOC) into sub-200-LOC modules
- [ ] AC3: All tests pass after each file split (TDD: no regressions)
- [ ] AC4: No new public API changes — splits are internal reorganization only
- [ ] AC5: Reduce total count of >200 LOC files by at least 50% (from ~20 to <=10)
- [ ] AC6: Add CI step that fails on new files exceeding 200 LOC
- [ ] AC7: Document splitting patterns used (for future reference)

## Scope Files

```yaml
scope_files:
  # Priority 1: >400 LOC (must split)
  - sdp-plugin/cmd/sdp/contract.go
  - src/sdp/agents/synthesis_agent.go
  - src/sdp/agents/code_analyzer.go
  - src/sdp/agents/contract_validator.go
  - sdp-plugin/internal/doctor/doctor.go
  - sdp-plugin/cmd/sdp/decisions.go

  # Priority 2: 300-400 LOC (should split)
  - sdp-plugin/internal/orchestrator/feature_coordinator.go
  - sdp-plugin/internal/ui/dashboard/app.go
  - sdp-plugin/cmd/sdp/metrics.go
  - sdp-plugin/internal/telemetry/analyzer.go

  # CI enforcement
  - .github/workflows/go-ci.yml
```

## Implementation Notes

### Splitting Strategy

For each oversized file:

1. **Identify cohesive groups** — functions that operate on the same data or concept
2. **Extract to new file** — move function group to `{base}_{concept}.go`
3. **Keep package unchanged** — no new packages, just new files within existing package
4. **Run tests** — verify all tests pass after split
5. **Verify imports** — ensure no circular dependencies introduced

### Example Split Pattern

```
contract.go (572 LOC) →
  contract.go          (120 LOC) — types and main command
  contract_validate.go (150 LOC) — validation logic
  contract_generate.go (130 LOC) — generation logic
  contract_compare.go  (170 LOC) — comparison logic
```

### CI LOC Check

Add to `go-ci.yml`:
```bash
# Check for files exceeding 200 LOC
OVERSIZED=$(find . -name "*.go" -not -name "*_test.go" -exec sh -c 'lines=$(wc -l < "$1"); [ "$lines" -gt 200 ] && echo "$1: $lines LOC"' _ {} \;)
if [ -n "$OVERSIZED" ]; then
  echo "ERROR: Files exceeding 200 LOC limit:"
  echo "$OVERSIZED"
  exit 1
fi
```

### Phased Approach

Phase 1 (this WS): Split top 10 offenders, add CI check as warning
Phase 2 (future WS): Split remaining, convert CI check to error

## Definition of Done

- [ ] Top 10 oversized files split to <=200 LOC each
- [ ] All tests pass (zero regressions)
- [ ] CI LOC check added
- [ ] Total >200 LOC file count reduced by >=50%
- [ ] AC1-AC7 met
