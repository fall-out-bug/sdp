---
ws_id: 00-050-06
parent: sdp-79u
feature: F050
status: backlog
size: MEDIUM
project_id: 00
---

## WS-00-050-06: Quality Watcher (Real-Time Feedback)

### ðŸŽ¯ Goal

Implement background file watcher with real-time quality feedback. Enable continuous quality monitoring during development with desktop notifications on failures.

**What must WORK after completing this WS:**
- Watcher monitors `.py` files via fsnotify
- Debounce file changes (500ms delay)
- Run incremental quality checks on changed files
- Cache results in `.quality-cache.json`
- Desktop notification on quality failures

**Acceptance Criteria:**
- [ ] AC1: Watcher monitors all .py files in project
- [ ] AC2: Debounce delays checks by 500ms (batch rapid changes)
- [ ] AC3: Incremental checks run only on changed files
- [ ] AC4: Results cached in `.quality-cache.json`
- [ ] AC5: Desktop notification displays on quality failure
- [ ] AC6: `sdp quality watch` runs until Ctrl+C
- [ ] Coverage â‰¥ 80%

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### ðŸ“‹ Contracts

**Technical Constraints:**
- Must use fsnotify for cross-platform file watching
- Must implement debouncing (500ms delay)
- Must use JSON cache file for fast lookups
- Must support desktop notifications (OS-specific)

---

### ðŸ”Œ Interfaces

```go
package quality

type FileEvent struct {
    Path     string
    Op       fsnotify.Op
    Time     time.Time
}

type CacheEntry struct {
    Path         string
    LastChecked  time.Time
    MypyPassed   bool
    RuffPassed   bool
    Coverage     float64
}

type Watcher struct {
    notify   *fsnotify.Watcher
    cache    *Cache
    debounce time.Duration
}

func NewWatcher(targetDir string) (*Watcher, error)
func (w *Watcher) Run(ctx context.Context) error
func (w *Watcher) handleEvent(event FileEvent) error
func (w *Watcher) runIncrementalChecks(path string) error
func (w *Watcher) sendNotification(msg string) error
```

---

### ðŸ“ Scope Files

**Implementation:**
- `internal/quality/watcher.go`
- `internal/quality/cache.go`
- `internal/quality/debounce.go`
- `internal/quality/notify.go`
- `cmd/sdp/commands/watch.go`

**Tests:**
- `internal/quality/watcher_test.go`

---

### âœ… Testing

**Unit Tests:**
```bash
# File watching
TestWatchNewFile()
TestWatchModifyFile()
TestWatchDeleteFile()

# Debouncing
TestDebounceRapidChanges()
TestDebounceStableAfterDelay()

# Cache operations
TestCacheWrite()
TestCacheRead()
TestCacheInvalidation()

# Notifications
TestNotificationSuccess()
TestNotificationError()
```

**Integration Tests:**
```bash
# Terminal 1
sdp quality watch &
[Watching for file changes...]

# Terminal 2
vim src/module.py  # Edit file

# Terminal 1 (desktop notification)
âš ï¸ Quality gate FAILED: src/module.py:42: missing type hints
```

---

### ðŸ” Verification

**Pre-build:**
- [ ] Review fsnotify integration
- [ ] Verify debouncing logic
- [ ] Check cache file path resolution
- [ ] Test notification commands (OS-specific)

**Post-build:**
```bash
# Run tests
go test ./internal/quality/... -v -cover

# Manual integration test
sdp quality watch

# In another terminal:
touch test.py
echo "def foo():" >> test.py
echo "    pass" >> test.py

# Expected: Notification appears after 500ms
```

---

### ðŸ“ Notes

**Dependencies:** 00-050-05

**Context:**
Real-time quality watcher (500 LOC). Recommendation from deep-thinking: "Real-time hooks during coding (not just at commit time) reduce manual gate running by 80%."

**Key Decisions:**
- fsnotify for cross-platform file watching
- 500ms debounce (batch rapid changes)
- JSON cache (avoid redundant checks)
- OS-specific notifications (terminal-notifier, notify-send)

**Risks:**
- fsnotify not supported on some filesystems
- Notification command not available
- Cache file corruption
- Too many notifications (spam)

**Mitigations:**
- Fallback to polling if fsnotify fails
- Silent failure if notifications unavailable
- Cache validation on load
- Deduplicate notifications within 1min

**Platform-Specific:**
- macOS: `terminal-notifier`
- Linux: `notify-send`
- Windows: Not supported (skip silently)

**Performance:**
- Incremental checks (only changed files)
- Cache hit rate >80%
- Memory footprint <50MB
