---
ws_id: "00-053-00"
feature_id: "F053"
title: "Workstream 00-053-00: Contract Synthesis Agent"
status: backlog
priority: 2
size: MEDIUM
depends_on: []
blocks: []
---

# Workstream 00-053-00: Contract Synthesis Agent

**Feature:** F053 - Component Contract Validation
**Issue:** sdp-ie25.1
**Project ID:** 00
**Status:** Pending
**Priority:** P0 (Critical Path)

## Overview

Implement multi-agent contract synthesis system that enables PRE-CODE contract agreement BEFORE parallel implementation begins. This prevents the integration mismatch problem where frontend, backend, and SDK agents implement incompatible APIs.

## Problem Statement

From user feedback: "Что толку в длинных опросах, если в итоге продукт разваливается?" (What's the point of long interviews if the product falls apart in the end?)

**Root cause:** Agents implement components in parallel without contract agreement, leading to:
- Frontend: POST /api/v1/telemetry/submit
- Backend: POST /api/v1/telemetry/events
- SDK: telemetryClient.submit(data)
- Result: 404 Not Found

## Solution

Contract synthesis phase that runs BEFORE implementation:
1. Architect agent proposes initial contract based on requirements
2. Frontend/backend/sdk agents review in parallel
3. Synthesizer agent resolves conflicts using domain expertise rules
4. All agents agree → FIXED CONTRACT
5. Contract lock prevents drift during implementation

## Acceptance Criteria

1. **Contract synthesis agent** implemented in `src/sdp/agents/synthesis_agent.go`
2. Analyzes requirements from `docs/drafts/{feature}-requirements.md`
3. Proposes initial OpenAPI 3.0 contract
4. Sends contract to frontend, backend, SDK agents for parallel review
5. Collects feedback (endpoint changes, schema modifications)
6. Applies synthesis rules:
   - Domain expertise veto (frontend/backend/sdk have veto power)
   - Quality gate (all must agree)
   - Merge (combine suggestions)
   - Escalate (ask human if unresolved)
7. Outputs agreed contract to `.contracts/{feature}.yaml`
8. Returns success/failure with conflict resolution report

## Scope

### In Scope
- Contract synthesis agent implementation
- Multi-agent coordination via Task tool
- Synthesis rules engine
- OpenAPI 3.0 contract generation
- Conflict resolution algorithm
- Contract output to `.contracts/` directory

### Out of Scope
- Contract lock mechanism (WS 00-053-06)
- CLI command interface (WS 00-053-05)
- Contract validation (WS 00-053-03)
- @design integration (WS 00-053-04)

## Implementation Approach

### Phase 1: Core Agent Structure
1. Create `src/sdp/agents/synthesis_agent.go`
2. Define `ContractSynthesizer` struct
3. Implement `AnalyzeRequirements()` method
4. Implement `ProposeContract()` method

### Phase 2: Multi-Agent Review
1. Implement `RequestReview()` method (spawns frontend/backend/sdk agents)
2. Implement `CollectFeedback()` method
3. Define feedback structure (endpoint_changes, schema_modifications, conflicts)

### Phase 3: Synthesis Rules Engine
1. Implement `ApplySynthesisRules()` method
2. Define rule priority:
   - Unanimous agreement (Priority 1)
   - Domain expertise veto (Priority 2)
   - Quality gate (Priority 3)
   - Merge suggestions (Priority 4)
   - Escalate to human (Priority 5)
3. Implement conflict resolution algorithm

### Phase 4: Contract Output
1. Implement `WriteContract()` method
2. Generate OpenAPI 3.0 YAML
3. Validate output against schema
4. Write to `.contracts/{feature}.yaml`

## Dependencies

**UPSTREAM:** None (can start immediately)

**DOWNSTREAM:**
- WS 00-053-05 (CLI synthesize command uses this agent)
- WS 00-053-06 (CLI lock command uses contract output)

## Testing

### Unit Tests
- `TestContractSynthesizer_AnalyzeRequirements`
- `TestContractSynthesizer_ProposeContract`
- `TestContractSynthesizer_ApplySynthesisRules`
- `TestConflictResolution_UnanimousAgreement`
- `TestConflictResolution_DomainExpertiseVeto`
- `TestConflictResolution_MergeSuggestions`

### Integration Tests
- `TestEndToEnd_ContractSynthesis`
- Use sample requirements file
- Verify output contract valid OpenAPI 3.0
- Verify conflict resolution works

## Quality Gates

- Files < 200 LOC
- Cyclomatic complexity < 10
- Test coverage ≥ 80%
- No bare exceptions
- Full type hints

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tests passing (unit + integration)
- [ ] Coverage ≥ 80%
- [ ] Code review approved
- [ ] Documentation updated
- [ ] Integration test passes with sample requirements
- [ ] Contract output valid OpenAPI 3.0

## Notes

**Critical Path:** This is the foundation for the entire contract validation system. All other workstreams depend on this one.

**Key Insight:** Contract synthesis MUST happen BEFORE implementation starts. The synthesis agent is called at the end of @design phase, after workstreams are created but before @oneshot execution begins.

**Synthesis Rules Priority:**
1. Unanimous - all agents agree → use as-is
2. Domain expertise - highest confidence in domain wins
3. Quality gate - best quality score
4. Merge - combine best parts
5. Escalate - ask human for resolution

## Execution Report Template

```
**Started:** [Timestamp]
**Completed:** [Timestamp]
**Duration:** Xm

**Files Modified:**
- src/sdp/agents/synthesis_agent.go (NEW, X LOC)
- src/sdp/agents/synthesis_agent_test.go (NEW, Y LOC)

**Test Results:**
- Unit tests: X/Y passing
- Integration tests: A/B passing
- Coverage: Z%

**Contract Output:**
- Sample contract generated for test feature
- Valid OpenAPI 3.0 schema

**Challenges:**
- [Any issues encountered]

**Follow-up Work:**
- [Dependencies on downstream workstreams]
```
