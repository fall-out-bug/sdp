# P2-08-01: Re-Fix Code Review Issues

**Date:** 2026-01-30
**Parent:** P2-08 (Investigation complete)
**Status:** Ready to start
**Priority:** P2 (Quality gate violations)
**Estimated:** 30 minutes

---

## Background

Commit d60c3b1 fixed critical code quality issues but was prematurely reverted 73 seconds later (cd6ec07). The revert created quality gate violations:
- File size violation: `scripts/migrate_workstream_ids.py` (396 LOC, should be < 200)
- Complexity violation: `src/sdp/prd/parser_python.py` (CC > 10)
- Code duplication: `WorkstreamMigrator` class in 2 files

**Investigation report:** `docs/reports/2026-01-30-P2-08-code-review-revert-investigation.md`

---

## Tasks

### 1. Fix parser_python.py Complexity (10 min)

**File:** `src/sdp/prd/parser_python.py`
**Current Issue:** Functions have CC > 10

**Changes:**
- Extract `_PRDVisitor` class with helper methods
- Refactor `visit_FunctionDef()` to extract helper methods
- Target: All functions CC < 10

**Verification:**
```bash
radon cc src/sdp/prd/parser_python.py -a -s
# Expected: All functions CC < 10
```

---

### 2. Refactor migrate_workstream_ids.py (15 min)

**File:** `scripts/migrate_workstream_ids.py`
**Current Issue:** 396 LOC monolith (should be < 200)

**Changes:**
- Remove duplicated `WorkstreamMigrator` and `WorkstreamFile` classes
- Import from `src.sdp.scripts` instead
- Keep only thin CLI wrapper (~89 LOC total)

**Before (396 LOC):**
```python
# scripts/migrate_workstream_ids.py
# Contains duplicated classes (396 lines)

class WorkstreamMigrationError(Exception):
    ...

class WorkstreamFile:
    ... # 80+ lines

class WorkstreamMigrator:
    ... # 200+ lines

def main():
    ... # CLI wrapper
```

**After (~89 LOC):**
```python
# scripts/migrate_workstream_ids.py
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from sdp.scripts import WorkstreamMigrator, WorkstreamMigrationError

def main():
    """Thin CLI wrapper."""
    # CLI logic only (~89 LOC)

if __name__ == "__main__":
    main()
```

**Verification:**
```bash
wc -l scripts/migrate_workstream_ids.py
# Expected: < 200 LOC

pytest tests/unit/test_migrate_workstream_ids.py -v
# Expected: All tests pass
```

---

### 3. Update Tests (5 min)

**File:** `tests/unit/test_migrate_workstream_ids.py`

**Changes:**
- Update imports if needed
- Ensure tests import from correct location
- Run full test suite

**Verification:**
```bash
pytest tests/unit/test_migrate_workstream_ids.py -v
# Expected: All tests pass
```

---

## Commit Strategy

**Split into 3 commits for easier review and testing:**

1. **Commit 1:** `refactor(prd): Extract _PRDVisitor class to reduce complexity`
   - File: `src/sdp/prd/parser_python.py`
   - Test: radon cc shows all functions < 10

2. **Commit 2:** `refactor(scripts): Remove duplication from migrate_workstream_ids.py`
   - File: `scripts/migrate_workstream_ids.py`
   - Test: wc -l shows < 200 LOC, tests pass

3. **Commit 3:** `test(migration): Update imports for refactored scripts`
   - File: `tests/unit/test_migrate_workstream_ids.py`
   - Test: All tests pass

---

## Acceptance Criteria

- [ ] `src/sdp/prd/parser_python.py`: All functions have CC < 10
- [ ] `scripts/migrate_workstream_ids.py`: < 200 LOC (thin wrapper)
- [ ] No code duplication (classes only in `src/sdp/scripts/`)
- [ ] All tests passing (especially `test_migrate_workstream_ids.py`)
- [ ] No regressions in architecture changes (commit 76cfa8c)
- [ ] Quality gates pass:
  - File size < 200 LOC
  - Complexity < 10
  - Tests pass

---

## Verification Commands

```bash
# 1. Check complexity
radon cc src/sdp/prd/parser_python.py -a -s
# Expected: All functions CC < 10

# 2. Check file size
wc -l scripts/migrate_workstream_ids.py
# Expected: < 200 LOC

# 3. Check for duplication
grep -n "class WorkstreamMigrator" scripts/migrate_workstream_ids.py
# Expected: Not found (only in src/sdp/scripts/)

# 4. Run tests
pytest tests/unit/test_migrate_workstream_ids.py -v
# Expected: All pass

# 5. Full test suite
pytest
# Expected: All pass
```

---

## Rollback Plan

If issues arise:
1. Revert all 3 commits
2. Investigate test failures
3. Fix and try again

```bash
git revert HEAD~3..HEAD
```

---

## Notes

- File splitting architecture already in place (`src/sdp/scripts/`)
- Earlier fix (ccc8c2d) already resolved beads.py syntax error
- Architecture changes (76cfa8c) must continue working
- Take it slow - test after each commit

---

**Status:** Ready to start
**Oneshot ready:** âœ… Yes
**Dependencies:** None (investigation complete)
