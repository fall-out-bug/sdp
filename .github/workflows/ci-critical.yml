name: Critical Quality Gates

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened]

jobs:
  critical:
    name: Critical Checks (Blocking)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'poetry'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install --with dev

      - name: Check traceability
        run: |
          # Get WS ID from PR title or branch
          WS_ID=$(echo "${{ github.head_ref }}" | grep -oE '[0-9]{2}-[0-9]{3}-[0-9]{2}' || echo "")
          
          if [ -n "$WS_ID" ]; then
            echo "Checking traceability for WS $WS_ID..."
            poetry run sdp trace check "$WS_ID" || {
              echo "::error::Traceability check failed. Some ACs don't have tests."
              exit 1
            }
          else
            echo "No WS ID found in branch name (${{ github.head_ref }}), skipping traceability check"
          fi

      - name: Run tests with coverage
        run: |
          poetry run pytest \
            --cov=src/sdp \
            --cov-fail-under=80 \
            --cov-report=term-missing \
            --cov-report=xml
        # NO continue-on-error - failure blocks PR

      - name: Type checking (mypy strict)
        run: poetry run mypy --strict src/sdp
        # NO continue-on-error

      - name: Linting (ruff errors only)
        run: poetry run ruff check src/sdp --select=E,F
        # NO continue-on-error

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ❌ Critical Quality Gate Failed
            
            One or more critical checks failed. PR cannot be merged until fixed.
            
            ### What to do
            
            1. Check the workflow logs for details
            2. Fix the failing checks
            3. Push fixes to update PR
            
            ### Critical Checks
            
            - ✅ Traceability: All ACs must have tests
            - ✅ Tests must pass
            - ✅ Coverage must be ≥80%
            - ✅ mypy --strict must pass
            - ✅ ruff errors (E, F) must be fixed
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
